---
title: "test"
author: "test"
date: "Wednesday, May 27, 2015"
output: 
  ioslides_presentation:
    widescreen: true
    smaller: true
    logo: USGS_avatar_github.png
---

## Collaborators
- USEPA: 
 - Duluth, MN
 - Athens, GA

This is an R Markdown presentation. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

## Slide with Bullets

- Bullet 1
- Bullet 2
- Bullet 3

## Slide with R Code and Output

```{r message=FALSE, echo=FALSE}

library(dplyr)
library(reshape2)
library(DT)
library(toxEval)

endPointInfo <- endPointInfo
# AC50 data provided in the toxEval package:
AC50gain <- AC50gain
packagePath <- system.file("extdata", package="toxEval")
#Site Info:
filePath <- file.path(packagePath, "stationINFO.RData")
load(file=filePath)
#parameter info:
filePath <- file.path(packagePath, "pCodeInfo.RData")
load(file=filePath)


pCodeInfo <- pCodeInfo[pCodeInfo$casrn != "", ]
packagePath <- system.file("extdata", package="toxEval")
filePath <- file.path(packagePath, "waterSamples.RData")
load(file=filePath)

waterSamplePCodes <- names(waterSamples)[grep("valueToUse", 
                                              names(waterSamples))]
waterSamplePCodes <- sapply(strsplit(waterSamplePCodes, "_"), function(x) x[2])


AC50 <- left_join(AC50gain, 
                  pCodeInfo[pCodeInfo$parameter_cd %in% waterSamplePCodes,
                            c("casrn", "parameter_units", "mlWt")],
                   by= c("casn"="casrn")) %>%
  filter(!is.na(parameter_units)) %>%
  rename(desiredUnits = parameter_units) %>%
  mutate(conversion = mlWt) %>%
  select(casn, chnm, desiredUnits, mlWt, conversion)

AC50Converted <- left_join(AC50, AC50gain, by = c("casn", "chnm"))
infoColumns <- c("casn", "chnm", "desiredUnits","mlWt", "conversion", "code","chid")

endPointData <- AC50Converted[,!(names(AC50Converted) %in% infoColumns)]
endPointData <- 10^endPointData
endPointData <- endPointData * AC50Converted$conversion
endPoint <- cbind(AC50, data.frame(endPointData))
endPoint <- rename(endPoint, Units=desiredUnits)

qualColumns <- grep("qualifier", names(waterSamples))
valColumns <- grep("valueToUse", names(waterSamples))

waterData <- waterSamples[,valColumns]
waterData[waterSamples[,qualColumns] == "<"] <- 0

newSiteKey <- setNames(stationINFO$shortName, stationINFO$fullSiteID)
wData <- cbind(waterSamples[,1:2],waterData)

siteSummary <- wData %>%
  melt(id.vars=c("ActivityStartDateGiven","site")) %>%
  mutate(variable=as.character(variable)) %>%
  filter(!is.na(value)) %>%
  rename(measuredValue=value, pCode=variable, date=ActivityStartDateGiven) %>%
  mutate(pCode=sapply(strsplit(pCode, "_"), function(x) x[2])) %>%
  left_join(pCodeInfo[c("parameter_cd","casrn","class","srsname")], by=c("pCode"="parameter_cd")) %>%
  select(srsname,casrn, class, measuredValue, site, date) %>%
  right_join(endPoint, by=c("casrn"="casn")) %>%
  select(-mlWt, -conversion, -casrn,  -Units, -srsname) %>%
  melt(id.vars = c("class", "site", "date","measuredValue","chnm")) %>% 
  filter(!is.na(value)) %>%
  mutate(variable=as.character(variable)) %>%
  rename(endPointValue=value, endPoint=variable) %>%
  mutate(EAR=measuredValue/endPointValue) %>%
#   filter(EAR > 0.1) %>%
  mutate(site=newSiteKey[site]) %>%
  select(site, chnm, EAR, endPoint, class, date) %>% 
  arrange(site, chnm, EAR)


summ1 <- siteSummary %>%
  group_by(site) %>% #FIX FREQ!!!!!!!!!!!!!!!!
  summarize(minEAR=min(EAR), 
            maxEAR=max(EAR), 
            hits=sum(EAR > 0.1), 
            nChem=length(unique(chnm)), 
            nEndPoints=length(unique(endPoint)),
            nSamples = length(unique(date))) %>%
#             ,freq = hits/(nSamples*nChem)) %>% # I don't think this makes sense with multi-endpoints
  select(site, minEAR, maxEAR, hits, nChem, nEndPoints, nSamples) %>%
  data.frame %>%
  arrange(desc(maxEAR))  


```

## Passive Chemical Summary

```{r, echo=FALSE, results='asis'}
datatable(summ1, rownames = FALSE, 
          options = list(pageLength = 10)) %>% 
  formatRound(c("minEAR","maxEAR"), digits = 2)
```

## Passive Site Summary

## Map

```{r, echo=FALSE, results='asis'}
library(leaflet)
stationINFO <- stationINFO[!is.na(stationINFO$dec.lat.va),]

mapData <- left_join(stationINFO, summ1, by=c("shortName"="site"))
mapData <- mapData[!is.na(mapData$dec.lat.va),]

col_types <- c( "red","orange", "yellow", "grey80","dodgerblue","darkblue")
leg_vals <- seq(0,2500, 500)

cols <- colorNumeric(col_types, domain = leg_vals)
rad <- seq(2500,15000, 2500)
mapData$sizes <- rad[as.numeric(cut(mapData$hits, c(-1,0,1,10,50,100,1000)))]

m = leaflet(mapData) %>%
  addProviderTiles("Esri.WorldPhysical") %>%
  setView(lng = -84.45, lat = 43.8, zoom=5)%>%
  addCircles(lat=~dec.lat.va, lng=~dec.long.va, 
             popup=mapData$shortName,
             fillColor = ~cols(maxEAR),
             color = "grey60", 
             fillOpacity = 0.8, radius = ~sizes, opacity = 0.8) %>%
    addLegend(
      position = 'bottomleft',
      colors = cols(leg_vals),
      labels = paste0(leg_vals,''), opacity = 0.8,
      title = 'maxEAR') 
m  # a map with the default OSM tile laye

```
