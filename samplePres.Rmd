---
title: "Test"
author: "R"
date: "Wednesday, May 13, 2015"
output: 
  ioslides_presentation:
    widescreen: true
    smaller: true
    logo: USGS_avatar_github.png
---

## R Markdown

This is an R Markdown presentation. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document.

## Slide with Bullets

- Bullet 1
- Bullet 2
- Bullet 3

## Slide with R Code and Output

```{r echo=FALSE, message=FALSE}

library(dplyr)
library(reshape2)
library(DT)
library(rmarkdown)

packagePath <- system.file("extdata", package="toxEval")
filePath <- file.path(packagePath, "passiveData.RData")
load(file=filePath)
#Site Info:
filePath <- file.path(packagePath, "stationINFO.RData")
load(file=filePath)
#parameter info:
filePath <- file.path(packagePath, "pCodeInfo.RData")
load(file=filePath)

#passive class info:
passiveCAS <- readRDS(file.path(packagePath, "passiveCAS.rds"))

pCodeInfo <- pCodeInfo[pCodeInfo$casrn != "", ]

# Some chemicals have 2 rows (different units)...
# To simplify for now, we'll ignore the duplicate chemicals:


passiveData <- left_join(passiveData, passiveCAS, by=c("CAS", "Chemical"))
passiveData <- passiveData[!duplicated(passiveData$CAS),]
passiveData$class[passiveData$Chemical == "Aspirin"] <-"Pharmaceuticals"

passiveData <- passiveData[,-which(names(passiveData) == "site04249000.1")]

library(toxEval)

# AC50 data provided in the toxEval package:
AC50gain <- AC50gain

unitConversion <- setNames(c(10^6, 10^3), c("pg/L", "ng/L") )

AC50 <- right_join(AC50gain[,c("casn"), drop=FALSE], 
                   passiveData[,c("CAS", "Units", "mlWt")],
                   by= c("casn" = "CAS")) %>%
  rename(desiredUnits = Units) %>%
  filter(!is.na(mlWt)) %>%
  mutate(conversion = unitConversion[desiredUnits] * mlWt) %>%
  select(casn, desiredUnits, mlWt, conversion)

AC50Converted <- left_join(AC50, AC50gain, by="casn")
infoColumns <- c("casn", "chnm", "desiredUnits","mlWt", "conversion", "code","chid")

endPointData <- AC50Converted[,!(names(AC50Converted) %in% infoColumns)]
endPointData <- 10^endPointData
endPointData <- endPointData * AC50Converted$conversion
endPoint <- cbind(AC50, data.frame(endPointData)) %>%
  rename(Units=desiredUnits) %>%
  filter(rowSums(is.na(endPointData)) != ncol(endPointData))

endPointData <- endPointData[rowSums(is.na(endPointData)) != 
                               ncol(endPointData),]

siteColumns <- grep("site",names(passiveData))
passiveData[,siteColumns] <- suppressWarnings(
  sapply(passiveData[,siteColumns], function(x) as.numeric(x)))

#For this analysis, we'll consider NA's to be 0 (other options exist):
passiveData[,siteColumns][is.na(passiveData[,siteColumns])] <- 0

infoColumns <- c("Chemical", "CAS", "Units", "MLD", "MQL", "mlWt","class")

chemicalSummary <- melt(passiveData, id.vars = infoColumns) %>%
  mutate(variable=as.character(variable)) %>%
  filter(value != 0) %>%
  rename(measuredValue=value, site=variable) %>%
  right_join(endPoint, by=c("CAS"="casn", "Units"="Units", "mlWt"="mlWt")) %>%
  melt(id.vars = c(infoColumns, "site", "measuredValue","conversion")) %>% 
  mutate(variable=as.character(variable)) %>%
  rename(endPointValue=value, endPoint=variable) %>%
  filter(!is.na(endPointValue)) %>%
  mutate(EAR=measuredValue/endPointValue) %>%
  filter(EAR > 0.1) %>%
  group_by(Chemical, endPoint, class) %>%
  summarize(minEAR=min(EAR), maxEAR=max(EAR), hits=length(EAR), nSites=ncol(passiveData)) %>%
  left_join(endPointInfo, by=c("endPoint"="assay_component_endpoint_name")) %>%
  select(Chemical, minEAR, maxEAR, hits, nSites, endPoint, class, contains("intended_target_")) %>%
  arrange(Chemical, desc(maxEAR)) %>%
  rename(type=intended_target_type, type_sub=intended_target_type_sub,
         family=intended_target_family, family_sub=intended_target_family_sub) %>%
  select(-contains("intended_target_")) %>% 
    data.frame %>%
  arrange(desc(maxEAR)) %>%
  mutate(frequency=hits/nSites)

  chemicalSummary <- unique(chemicalSummary) #some endpoints have multiple genes....so there are duplicated rows, there wouldn't be if we didn't have select(-contains("intended_target_"))

```

## Passive Chemical Summary

```{r, echo=FALSE, results='asis'}
  datatable(chemicalSummary[,c("Chemical","minEAR","maxEAR","frequency","class")], rownames = FALSE, 
            options = list(pageLength = 10)) %>% 
    formatRound(c("minEAR","maxEAR","frequency"), digits = 2)
```

## Passive Site Summary

## Map

```{r, echo=FALSE, results='asis'}
library(leaflet)
stationINFO <- stationINFO[!is.na(stationINFO$dec.lat.va),]



m = leaflet(stationINFO) %>%
  addProviderTiles("Esri.WorldPhysical") %>%
  setView(lng = -84.45, lat = 43.8, zoom=6)%>%
  addCircles(lat=~dec.lat.va, lng=~dec.long.va) 
m  # a map with the default OSM tile laye

```
