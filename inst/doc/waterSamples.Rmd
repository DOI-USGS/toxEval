---
title: "Water Samples: ToxCast"
author: "Steven R. Corsi, Laura A. De Cicco"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
    fig_caption: yes
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Water Samples: ToxCast}
  \usepackage[utf8]{inputenc}
---


```{r setup, include=FALSE}
options(continue=" ")
options(width=100)
library(knitr)
library(rmarkdown)
library(dplyr)
library(reshape2)
library(DT)
library(ggplot2)

```

# Introduction

```{r message=FALSE, echo=FALSE}
library(toxEval)
endPointInfo <- endPointInfo
# AC50 data provided in the toxEval package:
AC50gain <- AC50gain

```


```{r echo=FALSE, eval=TRUE}
packagePath <- system.file("extdata", package="toxEval")
#Site Info:
filePath <- file.path(packagePath, "stationINFO.RData")
load(file=filePath)
#parameter info:
filePath <- file.path(packagePath, "pCodeInfo.RData")
load(file=filePath)


pCodeInfo <- pCodeInfo[pCodeInfo$casrn != "", ]

# Some chemicals have 2 rows (different units)...
# To simplify for now, we'll ignore the duplicate chemicals:



```


# Water Sample Data
The data returned from water sample tests was returned in a 'wide' format:

```{r echo=TRUE, eval=TRUE}
packagePath <- system.file("extdata", package="toxEval")
filePath <- file.path(packagePath, "waterSamples.RData")
load(file=filePath)

head(waterSamples[,1:10])

```

The first job is to once again find the unique units. This data is arranged by a 5 digit USGS parameter code. Using the **dataRetrieval** package, information about the parameter codes can be retrieved. Each parameter code has 6 columns: detectionLimit, rep_lev_cd, qualifier, valueToUse, val_qual_tex, meth_cd, dqi_cd. We can pull out one of those columns to find the unique paremeter codes, then use **webchem** to get the molecular weights.


```{r message=FALSE, echo=FALSE}

waterSamplePCodes <- names(waterSamples)[grep("valueToUse", names(waterSamples))]
waterSamplePCodes <- sapply(strsplit(waterSamplePCodes, "_"), function(x) x[2])



```

In this dataset, all the data is reported in `r unique(pCodeInfo$parameter_units)`. Our conversion therefore is:

$$
\require{cancel}
\begin{aligned}
Reported Data = \log \mu M \\
\mu M = 10^{\log \mu M} \\
MW = \frac{g}{mol} , M = \frac{mol}{L}  \\
\cancel{\mu M} \left[\frac{\cancel{M}}{\cancel{10^6} \cancel{\mu M}}\right] \left[\frac{1}{\cancel{M}}  \frac{\cancel{mol}}{L}\right] \left[ \frac{MW \cancel{g}}{\cancel{mol}}\right] \left[\frac{\cancel{10^6} \mu g}{\cancel{g}}\right] = MW * \frac{\mu g}{L} 
\end{aligned}
$$

```{r}

AC50_ws <- left_join(AC50gain, pCodeInfo[pCodeInfo$parameter_cd %in% waterSamplePCodes,c("casrn", "parameter_units", "mlWt")],
                   by= c("casn"="casrn")) %>%
  filter(!is.na(parameter_units)) %>%
  rename(desiredUnits = parameter_units) %>%
  mutate(conversion = mlWt) %>%
  select(casn, chnm, desiredUnits, mlWt, conversion)

```

Next we can create a data frame with the AC50 converted endpoints:
```{r}
AC50Converted <- left_join(AC50_ws, AC50gain, by = c("casn", "chnm"))
infoColumns <- c("casn", "chnm", "desiredUnits","mlWt", "conversion", "code","chid")

endPointData <- AC50Converted[,!(names(AC50Converted) %in% infoColumns)]
endPointData <- 10^endPointData
endPointData <- endPointData * AC50Converted$conversion
endPoint <- cbind(AC50_ws, data.frame(endPointData))
endPoint <- rename(endPoint, Units=desiredUnits)

```

First, let's look at the extreme reported endpoint (not including `r NA`'s...that will actually may be important):

```{r warning=FALSE}
maxEndPoints <- apply(endPointData, 1, max, na.rm=TRUE) 
minEndPoints <- apply(endPointData, 1, min, na.rm=TRUE)

maxMinSummary <- cbind(endPoint[,c("chnm", "casn", "Units")], 
                       maxEndPoint=maxEndPoints, 
                       minEndPoint=minEndPoints)

```

The next task is to determine if the detectionLimit is going to tell us anything in relation to the ToxCast endpoints. Likewise, we can look at the maximum and minimum measured values.

```{r }
pCodeSummary <- select(pCodeInfo, srsname, casrn, parameter_units, mlWt) %>%
  filter(pCodeInfo$parameter_cd %in% waterSamplePCodes)

detectionLimits <- waterSamples[,grep("detectionLimit", names(waterSamples))]
detectionLimits <- na.omit(detectionLimits)

# Check if any change over time:
all(apply(detectionLimits, 2, function(x) length(unique(x))==1))

#They do!

```

## Water Sample Detection Levels

For now, we'll focus on the minimum detection level:
```{r warning=FALSE, echo=FALSE}
detLevels  <- data.frame(dl_pcode=names(detectionLimits),
                         minDetLevel=apply(detectionLimits, 2, min),
                         row.names=NULL, stringsAsFactors=FALSE) %>%
  mutate(pCode=sapply(strsplit(dl_pcode, "_"), function(x) x[2])) %>%
  left_join(pCodeInfo[c("parameter_cd","casrn","class")], 
            by=c("pCode"="parameter_cd")) %>%
  select(casrn, class, minDetLevel) %>%
  right_join(maxMinSummary, by=c("casrn"="casn")) %>%
  mutate(EAR=minDetLevel/minEndPoint) %>%
  arrange(desc(EAR)) %>%
  filter(EAR > 0.1) %>%
  rename(Chemical=chnm) %>%
  select(Chemical, EAR, minDetLevel, minEndPoint, class, Units)

datatable(detLevels, rownames = FALSE,options = list(pageLength = 25))  %>% 
    formatRound(c("EAR","minDetLevel", "minEndPoint"), digits = 3)

```

This table shows us the chemicals that `r detLevels$chnm` may lead to issues since the detection levels are higher than some of the end point values.

In this case therefore, we cannot simply ignore all of the left-censored values. However, for the time being, we will use only non-censored values in our analysis. Let's begin by trimming down the waterSamples data frame to only the relavent information. Here, we are setting all left-censored values to NA, we could instead use the detection limit.

```{r}
qualColumns <- grep("qualifier", names(waterSamples))
valColumns <- grep("valueToUse", names(waterSamples))

waterData <- waterSamples[,valColumns]
waterData[waterSamples[,qualColumns] == "<"] <- 0

```


## Chemical Summary Tables: Water Samples

### Overall
```{r message=FALSE, results='asis', echo=FALSE}
newSiteKey <- setNames(stationINFO$shortName, stationINFO$fullSiteID)

wData <- cbind(waterSamples[,1:2],waterData)
valColumns <- grep("valueToUse",names(wData))

chemicalSummary <- wData %>%
  melt(id.vars=c("ActivityStartDateGiven","site")) %>%
  mutate(variable=as.character(variable)) %>%
  filter(!is.na(value)) %>%
  rename(measuredValue=value, pCode=variable, date=ActivityStartDateGiven) %>%
  mutate(pCode=sapply(strsplit(pCode, "_"), function(x) x[2])) %>%
  left_join(pCodeInfo[c("parameter_cd","casrn","class","srsname")], by=c("pCode"="parameter_cd")) %>%
  select(srsname,casrn, class, measuredValue, site, date) %>%
  right_join(endPoint, by=c("casrn"="casn")) %>%
  select(-mlWt, -conversion, -casrn,  -Units, -srsname) %>%
  melt(id.vars = c("class", "site", "measuredValue","chnm","date")) %>% 
  filter(!is.na(value)) %>%
  mutate(variable=as.character(variable)) %>%
  rename(endPointValue=value, endPoint=variable) %>%
  mutate(EAR=measuredValue/endPointValue) 


chemSum1 <- chemicalSummary %>%
  group_by(chnm,  class, date, site) %>%
  summarize(hits= as.numeric(any(EAR > 0.1))) %>%
  group_by(chnm,  class, site) %>%
  summarize(hits=as.numeric(any(hits > 0)),
            counts=n(),
            freq=hits/counts) %>%
  group_by(chnm, class) %>%
  summarize(freq=sum(hits)/n()) # add nSite?

chemSum2 <- chemicalSummary %>%
  group_by(chnm,  class) %>%  
  summarize(maxEAR=max(EAR), 
            nSamples=nrow(unique(data.frame(date,site))),
            nEndPoints=length(unique(endPoint[EAR > 0.1]))) %>%
  left_join(chemSum1, by=c("chnm","class")) %>%
  data.frame %>%
  arrange(desc(freq)) %>%
  select(chnm, class, freq, maxEAR, nEndPoints, nSamples)

  datatable(chemSum2, rownames = FALSE, 
            options = list(pageLength = 10)) %>% 
    formatRound(c("maxEAR", "freq"), digits = 4)


```

### Individual EndPoints
Looking at individual endpoints (filtering only rows that have some hit):

```{r message=FALSE, results='asis', echo=FALSE}
###########################################
# nSites seems wrong???
###########################################
chemSum2 <- chemicalSummary  %>%
  group_by(chnm, endPoint, class) %>% 
  summarize(maxEAR=max(EAR), 
#there are some sites that have sample times at exactly the same time!:
            nSamples=nrow(unique(data.frame(date,site))), 
            freq=sum(EAR > 0.1)/nSamples, 
            nSites=length(unique(site[EAR>0.1]))) %>%
#This line adds rows because there are repeated endpoints in the endPointInfo table (maybe unique this table at the end to see if it matters)
  left_join(endPointInfo, by=c("endPoint"="assay_component_endpoint_name")) %>% 
  select(chnm, maxEAR, freq, nSamples, nSites, 
         endPoint, class, contains("intended_target_")) %>%
  rename(type=intended_target_type, type_sub=intended_target_type_sub,
         family=intended_target_family, family_sub=intended_target_family_sub) %>%
  select(-contains("intended_target_"))  %>%
  data.frame %>%
  filter(maxEAR > 0.1) %>%
  arrange(desc(maxEAR))  

  datatable(unique(chemSum2), rownames = FALSE, 
            options = list(pageLength = 10)) %>% 
    formatRound(c("maxEAR", "freq"), digits = 2)

```

## Site Summaries: Water Samples

The first site summary table groups only by site:

```{r message=FALSE, results='asis', echo=FALSE}

siteSummary <- wData %>%
  melt(id.vars=c("ActivityStartDateGiven","site")) %>%
  mutate(variable=as.character(variable)) %>%
  filter(!is.na(value)) %>%
  rename(measuredValue=value, pCode=variable, date=ActivityStartDateGiven) %>%
  mutate(pCode=sapply(strsplit(pCode, "_"), function(x) x[2])) %>%
  left_join(pCodeInfo[c("parameter_cd","casrn","class","srsname")], by=c("pCode"="parameter_cd")) %>%
  select(srsname,casrn, class, measuredValue, site, date) %>%
  right_join(endPoint, by=c("casrn"="casn")) %>%
  select(-mlWt, -conversion, -casrn,  -Units, -srsname) %>%
  melt(id.vars = c("class", "site", "date","measuredValue","chnm")) %>% 
  filter(!is.na(value)) %>%
  mutate(variable=as.character(variable)) %>%
  rename(endPointValue=value, endPoint=variable) %>%
  mutate(EAR=measuredValue/endPointValue) %>%
  mutate(site=newSiteKey[site]) %>%
  select(site, chnm, EAR, endPoint, class, date) %>% 
  arrange(site, chnm, EAR)

summ1 <- siteSummary %>%
  group_by(site, date) %>%
  summarize(hits= as.numeric(any(EAR > 0.1))) %>%
  group_by(site) %>%
  summarize(freq=sum(hits)/length(unique(date)),
            nSamples=length(unique(date))) 

summ2 <-  siteSummary %>%
  group_by(site) %>%
  summarize(nChem = length(unique(chnm[EAR > 0.1])),
            nEndPoints = length(unique(endPoint[EAR > 0.1])),
            maxEAR = max(EAR))


summary <- left_join(summ1, summ2, by="site") %>%
  arrange(desc(maxEAR))

datatable(summary, rownames = FALSE) %>% 
#           options = list(pageLength = 50)) %>% 
  formatRound(c("freq","maxEAR"), digits = 2)

```


## Water Sample Site Tables

```{r message=FALSE, results='asis', echo=FALSE}

for(i in summary$site[!is.na(summary$site)]){
  
  oneSite <- wData %>%
    mutate(site = newSiteKey[site]) %>%
    filter(site == i) 
  
  oneSiteLong <- select(oneSite, -site) %>%
    melt(id.vars=c("ActivityStartDateGiven")) %>%
    mutate(variable=as.character(variable)) %>%
    filter(!is.na(value)) %>%
    rename(measuredValue=value, pCode=variable, date=ActivityStartDateGiven) %>%
    mutate(pCode=sapply(strsplit(pCode, "_"), function(x) x[2])) %>%
    left_join(pCodeInfo[c("parameter_cd","casrn","class","srsname")], by=c("pCode"="parameter_cd")) %>%
    select(srsname,casrn, class, measuredValue, date) %>%
    right_join(endPoint, by=c("casrn"="casn")) %>%
    select(-mlWt, -conversion, -casrn,  -Units, -srsname) %>%
    melt(id.vars = c("class", "date","measuredValue","chnm")) %>% 
    filter(!is.na(value)) %>%
    mutate(variable=as.character(variable)) %>%
    rename(endPointValue=value, endPoint=variable) %>%
    mutate(EAR=measuredValue/endPointValue) %>%
    select(chnm, EAR, endPoint, class, date) %>% 
    arrange(chnm, EAR) %>%
    group_by(chnm, endPoint, class) %>%
    summarize(hits=sum(EAR > 0.10),
              nSamples=length(unique(date)),
              freq=hits/nSamples) %>%
    data.frame()%>%
    filter(freq>0) %>%
    arrange(chnm, desc(hits)) %>%
    left_join(endPointInfo, by=c("endPoint"="assay_component_endpoint_name")) %>%
    select(chnm, hits, freq, nSamples, class, endPoint, contains("intended_target_"))%>%
    rename(type=intended_target_type, type_sub=intended_target_type_sub,
           family=intended_target_family, family_sub=intended_target_family_sub,
           gene_id=intended_target_gene_id, gene_symbol=intended_target_gene_symbol) 

  if(nrow(oneSiteLong) > 0){
    cat("\n\n###", i, "\n")
    print(kable(oneSiteLong, digits=3,caption = i, row.names = FALSE))
  }
  

}

```


## Water sample visualizations

```{r fig.width=10, fig.height=10, warning=FALSE, echo=FALSE, fig.cap="Colors represent different endpoints, dots represent measured water sample values"}

# maxY <- 10
# data <- cbind(waterSamples[,1:2],waterData) %>%
#   melt(id.vars=c("ActivityStartDateGiven","site")) %>%
#   mutate(variable=as.character(variable)) %>%
#   filter(!is.na(value)) %>%
#   rename(measuredValue=value, pCode=variable) %>%
#   mutate(pCode=sapply(strsplit(pCode, "_"), function(x) x[2])) %>%
#   left_join(pCodeInfo[c("parameter_cd","casrn","class","srsname")], by=c("pCode"="parameter_cd")) %>%
#   select(srsname,casrn, class, measuredValue, site) %>%
#   right_join(endPoint, by=c("casrn"="casn")) %>%
#   select(-mlWt, -conversion, -casrn,  -Units, -srsname) %>%
#   melt(id.vars = c("class", "site", "measuredValue","chnm")) %>% 
#   filter(!is.na(value)) %>%
#   mutate(variable=as.character(variable)) %>%
#   rename(endPointValue=value, endPoint=variable) %>%
#   mutate(endPointValue=ifelse(endPointValue <= maxY, maxY, endPointValue)) 
# 
# # ggplot(ep[1:50,], aes(variable)) + geom_bar() + facet_wrap(~ chnm)
# # ggplot(ep[1:50,], aes(variable, fill=chnm)) + geom_bar() # + scale_fill_brewer()
# 
# ggplot(data, aes(x = chnm, y = endPointValue, fill=endPoint)) +
#     geom_bar(stat='identity',guide=FALSE,colour="grey") + 
#     ylim(0,10) +   
#     theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.25), legend.position = "none") +
#     labs(x = "Chemical", y="Concentration") + 
#     geom_point(aes(x=chnm, y=measuredValue))



```

```{r fig.width=10, fig.height=7, warning=FALSE, echo=FALSE, fig.cap="Boxplot of all EARS over 0.1"}

# data2 <- cbind(waterSamples[,1:2],waterData) %>%
#   melt(id.vars=c("ActivityStartDateGiven","site")) %>%
#   mutate(variable=as.character(variable)) %>%
#   filter(!is.na(value)) %>%
#   rename(measuredValue=value, pCode=variable) %>%
#   mutate(pCode=sapply(strsplit(pCode, "_"), function(x) x[2])) %>%
#   left_join(pCodeInfo[c("parameter_cd","casrn")], by=c("pCode"="parameter_cd")) %>%
#   select(casrn, measuredValue, site) %>%
#   right_join(endPoint, by=c("casrn"="casn")) %>%
#   select(-mlWt, -conversion, -casrn,  -Units) %>%
#   melt(id.vars = c("site", "measuredValue","chnm")) %>% 
#   filter(!is.na(value)) %>%
#   mutate(variable=as.character(variable)) %>%
#   rename(endPointValue=value, endPoint=variable) %>%
#   mutate(EAR = measuredValue/endPointValue) %>%
#   filter(EAR >= 0.1)
# 
# ggplot(data2, aes(x = chnm, y = EAR)) +
#     geom_boxplot() + 
#     ylim(0,3) +    
#     theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.25), legend.position = "none") +
#     labs(x = "Chemical", y="EAR")


```


```{r fig.width=10, fig.height=7, warning=FALSE, echo=FALSE, fig.cap="Boxplot of all max EARS per site per chemical (filtered over 0.1)"}

# data3 <- group_by(data2, site, chnm) %>%
#   mutate(maxEAR = max(EAR))
# 
# ggplot(data3, aes(x = chnm, y = maxEAR)) +
#     geom_boxplot() + 
#     ylim(0,3) +    
#     theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.25), legend.position = "none") +
#     labs(x = "Chemical", y="maxEAR")+ 
#     geom_point(aes(x=chnm, y=EAR, color="red"))

```


```{r fig.width=10, fig.height=7, warning=FALSE, echo=FALSE, fig.cap="Boxplot of  EARS per site (filtered over 0.1, max per endpoint)"}

# data4 <- mutate(data2, site = newSiteKey[site]) %>%
#   group_by(site, chnm, endPoint) %>%
#   mutate(maxEAR = max(EAR))
#   
# 
# ggplot(data4, aes(x = site, y = maxEAR)) +
#     geom_boxplot() + 
#     ylim(0,3) +    
#     theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.25), legend.position = "none") +
#     labs(x = "Site", y="maxEAR")+ 
#     geom_point(aes(x=site, y=EAR, color="red") )

```

