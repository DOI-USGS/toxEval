---
title: "Site Tables"
author: "<b>USGS</b>: Steve Corsi, Laura DeCicco, Austin Baldwin, David Alvarez, Peter Lenaker <br/><b>USEPA</b>: Anthony Schroeder, Dan Villeneuve, Brett Blackwell, Gerald Ankley"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
    fig_caption: yes
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Site Tables}
  \usepackage[utf8]{inputenc}
---

# Site Tables

## Water Samples, ToxCast

```{r message=FALSE, echo=FALSE, results='asis'}
library(dplyr)
library(tidyr)
library(DT)
library(toxEval)
library(knitr)


pCodeInfo <- pCodeInfo
wData <- wData
endPointInfo <- endPointInfo
# AC50 data provided in the toxEval package:
AC50gain <- AC50gain
packagePath <- system.file("extdata", package="toxEval")
filePath <- file.path(packagePath, "stationINFO.RData")
load(file=filePath)
newSiteKey <- setNames(stationINFO$shortName, stationINFO$fullSiteID)

endPoint <- endPointToxCreate(pCodeInfo)

chemicalSummary <- chemSummBasic(wData,pCodeInfo,endPoint)
siteSummary <- siteSumm(chemicalSummary,newSiteKey)

for(i in siteSummary$site){

  chemSummSite <- filter(chemicalSummary, site == names(newSiteKey)[i == newSiteKey])
  
  chemSummSite2 <- select(chemSummSite,-site, -endPoint, -endPointValue) %>%
    mutate(hits=as.numeric(EAR > 0.1))%>%
    group_by(chnm,class,date)%>%
    summarize(hits=as.numeric(any(hits>0)))%>%
    group_by(chnm,class)%>%
    summarize(freq=sum(hits)/n_distinct(date))
    
  
  chemSummSite1 <- chemSumm(chemSummSite) %>%
    select(-nSites,-freq)%>%
    left_join(chemSummSite2, by=c("chnm","class"))%>%
    data.frame()%>%
    filter(maxEAR > 0.1) %>%
    arrange(desc(maxEAR))
  
  names(chemSummSite1) <- c("Chemical", "Class","Maximum EAR", "Number of End Points", "Number of Samples","Frequency of Samples with Hits")
  
  if(nrow(chemSummSite1) > 0){
    cat("\n\n###", i, "\n")
    print(kable(chemSummSite1, digits=3,caption = i, row.names = FALSE))
  }
}

```