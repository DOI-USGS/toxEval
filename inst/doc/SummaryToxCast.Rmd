---
title: "Assessment of Potential Biological Effects in Great Lakes Tributaries Using ToxCast with Comparisons to Assessment Using Water Quality Guidelines."
author: "<b>USGS</b>: Steve Corsi, Laura DeCicco, Austin Baldwin, David Alvarez, Peter Lenaker <br/><b>USEPA</b>: Anthony Schroeder, Dan Villeneuve, Brett Blackwell, Gerald Ankley"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: true
    fig_caption: yes
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{ToxEval Summary}
  \usepackage[utf8]{inputenc}
---

```{r message=FALSE, echo=FALSE}
library(pander)
library(dplyr)
library(tidyr)
library(DT)
library(toxEval)
library(knitr)
library(leaflet)
library(formattable)
library(ggplot2)
library(gridExtra)
library(grid)

endPointInfo <- endPointInfo
# AC50 data provided in the toxEval package:
AC50gain <- AC50gain
packagePath <- system.file("extdata", package="toxEval")
#Site Info:
filePath <- file.path(packagePath, "stationINFO.RData")
load(file=filePath)
#parameter info:
# filePath <- file.path(packagePath, "pCodeInfo.RData")
# load(file=filePath)
# 
# pCodeInfo$class <- gsub("(^|[[:space:]])([[:alpha:]])", "\\1\\U\\2", tolower(pCodeInfo$class), perl=TRUE)
# pCodeInfo$class[pCodeInfo$class == "Pah"] <- "PAH"
# pCodeInfo$class[pCodeInfo$class == "Human Drug, Non Prescription"] <- "Pharmaceuticals"
# 
# pCodeInfo <- pCodeInfo[pCodeInfo$casrn != "", ]

pCodeInfo <- pCodeInfo

packagePath <- system.file("extdata", package="toxEval")
filePath <- file.path(packagePath, "waterSamples.RData")
load(file=filePath)

#Correct DEET:
# casDEET <- AC50gain$casn[AC50gain$chnm == "DEET"]
# pCodeDEET <- pCodeInfo$parameter_cd[pCodeInfo$casrn == casDEET]
# dlDEET <- min(waterSamples$valueToUse_61947, na.rm = TRUE)
# waterSamples$qualifier_61947 <- ifelse(waterSamples$valueToUse_61947 <= dlDEET*4, "<", "")
# Just removing DEET:
waterSamples <- waterSamples[,-grep("61947",x = names(waterSamples))]

waterSamples$site["USGS-04157005" == waterSamples$site] <- "USGS-04157000"

waterSamplePCodes <- names(waterSamples)[grep("valueToUse", 
                                              names(waterSamples))]
waterSamplePCodes <- sapply(strsplit(waterSamplePCodes, "_"), function(x) x[2])


AC50 <- left_join(AC50gain, 
                  pCodeInfo[pCodeInfo$parameter_cd %in% waterSamplePCodes,
                            c("casrn", "parameter_units", "mlWt")],
                   by= c("casn"="casrn")) %>%
  filter(!is.na(parameter_units)) %>%
  rename(desiredUnits = parameter_units) %>%
  mutate(conversion = mlWt) %>%
  select(casn, chnm, desiredUnits, mlWt, conversion)

AC50Converted <- left_join(AC50, AC50gain, by = c("casn", "chnm"))
infoColumns <- c("casn", "chnm", "desiredUnits","mlWt", "conversion", "code","chid")

endPointData <- AC50Converted[,!(names(AC50Converted) %in% infoColumns)]
endPointData <- 10^endPointData
endPointData <- endPointData * AC50Converted$conversion
endPoint <- cbind(AC50, data.frame(endPointData))
endPoint <- rename(endPoint, Units=desiredUnits)

qualColumns <- grep("qualifier", names(waterSamples))
valColumns <- grep("valueToUse", names(waterSamples))

waterData <- waterSamples[,valColumns]
waterData[waterSamples[,qualColumns] == "<"] <- 0

newSiteKey <- setNames(stationINFO$shortName, stationINFO$fullSiteID)
wData <- cbind(waterSamples[,1:2],waterData)

valColumns <- grep("valueToUse",names(wData))

newSiteKey <- setNames(stationINFO$shortName, stationINFO$fullSiteID)

wData <- cbind(waterSamples[,1:2],waterData)
valColumns <- grep("valueToUse",names(wData))

chemicalSummary <- wData %>%
  gather(pCode, measuredValue, -ActivityStartDateGiven, -site)  %>%
  rename(date=ActivityStartDateGiven)%>%
  filter(!is.na(measuredValue)) %>%
  separate(pCode, into=c("colHeader","pCode"), "_")%>%
  left_join(pCodeInfo[c("parameter_cd","casrn","class")], by=c("pCode"="parameter_cd"))  %>%
  right_join(endPoint, by=c("casrn"="casn")) %>%
  select(-mlWt, -conversion, -casrn,  -Units, -pCode, -colHeader) %>%
  gather(endPoint, endPointValue, -class, -site, -measuredValue, -chnm, -date)  %>% 
  filter(!is.na(endPointValue)) %>%
  mutate(EAR=measuredValue/endPointValue)


chemSum1 <- chemicalSummary %>%
  mutate(hits= as.numeric(EAR > 0.1)) %>%
  group_by(chnm,  class, site) %>%
  summarize(hits=as.numeric(any(hits > 0)), 
            median=median(EAR),
            maxEAR=max(EAR)) %>%
  group_by(chnm, class) %>%
  summarize(freq=sum(hits)/n_distinct(site),
            nSites=sum(hits),
            aveMedian=mean(median)) 

totalSamples <- select(chemicalSummary,date,site,chnm) %>%
  distinct()%>%
  group_by(chnm) %>%
  summarise(nSamples=n()) %>%
  mutate(chnm=as.character(chnm))

chemSum2 <- chemicalSummary %>%
  group_by(chnm,  class) %>%  
  summarize(maxEAR=max(EAR),
            nEndPoints=length(unique(endPoint[EAR > 0.1])),
            EAR90overall=quantile(EAR,probs = .9)) %>%
  left_join(chemSum1, by=c("chnm","class")) %>%
  left_join(totalSamples, by=c("chnm")) %>%
  data.frame %>%
  arrange(desc(freq)) %>%
  select(chnm, class, freq, maxEAR, nEndPoints, nSites, nSamples)

siteSummary <- wData %>%
  gather(pCode, measuredValue, -ActivityStartDateGiven, -site) %>%
  filter(!is.na(measuredValue)) %>%
  rename(date=ActivityStartDateGiven) %>%
  separate(pCode, into=c("colName","pCode"),sep="_") %>%
  select(-colName) %>%
  left_join(pCodeInfo[c("parameter_cd","casrn","class")], by=c("pCode"="parameter_cd")) %>%
  right_join(endPoint, by=c("casrn"="casn")) %>%
  select(-mlWt, -conversion, -casrn,  -Units, -pCode) %>%
  gather(endPoint, endPointValue, -class, -site, -date,-measuredValue,-chnm) %>%
  filter(!is.na(endPointValue)) %>%
  mutate(endPoint=as.character(endPoint),
         EAR=measuredValue/endPointValue,
         site=as.character(newSiteKey[site])) %>% 
  select(site, chnm, EAR, endPoint, class, date) %>% 
  arrange(site, chnm, EAR)
  
summ1 <- siteSummary %>%
  group_by(site, date) %>%  #This ignore chemicals...needs to be here for freq
  summarize(hits= as.numeric(any(EAR > 0.1))) %>%
  group_by(site) %>%
  summarize(freq=sum(hits)/n_distinct(date),
            nSamples=n_distinct(date)) 

summ2 <-  siteSummary %>%
  group_by(site) %>%
  summarize(nChem = length(unique(chnm[EAR > 0.1])),
            nEndPoints = length(unique(endPoint[EAR > 0.1])),
            maxEAR = max(EAR))

summary <- left_join(summ1, summ2, by="site") %>%
  arrange(desc(maxEAR))


```


```{r, echo=FALSE}

packagePath <- system.file("extdata", package="toxEval")
filePath <- file.path(packagePath, "passiveData.RData")
load(file=filePath)

#passive class info:
passiveCAS <- readRDS(file.path(packagePath, "passiveCAS.rds"))

pCodeInfo <- pCodeInfo[pCodeInfo$casrn != "", ]

# Some chemicals have 2 rows (different units)...
# To simplify for now, we'll ignore the duplicate chemicals:


passiveData <- left_join(passiveData, passiveCAS, by=c("CAS", "Chemical"))
passiveData <- passiveData[!duplicated(passiveData$CAS),]
passiveData$class[passiveData$Chemical == "Hexachlorobenzene (HCB)"] <-"OC Pesticides"
passiveData$class[passiveData$Chemical == "Pentachloroanisole (PCA)"] <-"OC Pesticides"
passiveData$class[is.na(passiveData$class)] <-"Pharmaceuticals"

passiveData <- passiveData[,-which(names(passiveData) == "site04249000.1")]


unitConversion <- setNames(c(10^6, 10^3), c("pg/L", "ng/L") )

AC50_passive <- right_join(AC50gain[,c("casn"), drop=FALSE], 
                   passiveData[,c("CAS", "Units", "mlWt","Chemical")],
                   by= c("casn" = "CAS")) %>%
  rename(desiredUnits = Units, chnm=Chemical) %>%
  filter(!is.na(mlWt)) %>%
  mutate(conversion = unitConversion[desiredUnits] * mlWt) %>%
  select(casn, chnm, desiredUnits, mlWt, conversion)

AC50Converted_passive <- left_join(AC50_passive, AC50gain, by = c("casn", "chnm"))
infoColumns <- c("casn", "chnm", "desiredUnits","mlWt", "conversion", "code","chid")

endPointData_passive <- AC50Converted_passive[,!(names(AC50Converted) %in% infoColumns)]
endPointData_passive <- 10^endPointData_passive
endPointData_passive <- endPointData_passive *  AC50Converted_passive$conversion
endPoint_passive <- cbind(AC50_passive, data.frame(endPointData_passive))
endPoint_passive <- rename(endPoint_passive, Units=desiredUnits)

siteColumns <- grep("site",names(passiveData))
passiveData[,siteColumns] <- suppressWarnings(
  sapply(passiveData[,siteColumns], function(x) as.numeric(x)))

#For this analysis, we'll consider NA's to be 0 (other options exist):
passiveData[,siteColumns][is.na(passiveData[,siteColumns])] <- 0

newSiteKey <- setNames(stationINFO$shortName, stationINFO$fullSiteID)

infoColumns <- c("Chemical", "CAS", "Units", "MLD", "MQL", "mlWt","class")

chemicalSummary_passive <- passiveData %>%
  gather(site, measuredValue, which(!(names(passiveData) %in% infoColumns) )) %>%
  filter(!is.na(measuredValue)) %>%
  select(casrn=CAS,class, measuredValue, site)%>%
  right_join(endPoint_passive, by=c("casrn"="casn")) %>%
  select(-mlWt, -conversion, -casrn,  -Units) %>%
  gather(endPoint, endPointValue, -class, -site, -measuredValue, -chnm) %>%
  filter(!is.na(endPointValue)) %>%
  mutate(EAR=measuredValue/endPointValue) 

chemSum1_passive <- chemicalSummary_passive %>%
  group_by(chnm,  class, site) %>%
  summarize(hits= as.numeric(any(EAR > 0.1))) %>%
  group_by(chnm, class) %>%
  summarize(freq=sum(hits)/n_distinct(site),
            nSites=sum(hits)) 

chemSum2_passive <- chemicalSummary_passive %>%
  group_by(chnm,  class) %>%  
  summarize(maxEAR=max(EAR), 
            nSamples=1,
            nEndPoints=length(unique(endPoint[EAR > 0.1]))) %>%
  left_join(chemSum1_passive, by=c("chnm","class")) %>%
  data.frame %>%
  select(chnm, class, freq, maxEAR, nEndPoints, nSites, nSamples) %>%
  arrange(desc(freq)) 

siteSummary_passive <- passiveData %>%
  gather(site, measuredValue, which(!(names(passiveData) %in% infoColumns))) %>%
  filter(!is.na(measuredValue)) %>%
  select(Chemical,CAS,class, measuredValue, site) %>%
  right_join(endPoint_passive, by=c("CAS"="casn")) %>%
  select(-mlWt, -conversion, -CAS,  -Units) %>%
  gather(endPoint,endPointValue,-Chemical,-class, -site, -measuredValue,-chnm) %>% 
  filter(!is.na(endPointValue)) %>%
  mutate(EAR=measuredValue/endPointValue) %>%
  mutate(site=newSiteKey[paste0("USGS-",gsub("[^0-9]", "", site))]) %>%
  select(site, chnm, EAR, endPoint, class) %>% 
  arrange(site, chnm, EAR)

summ1_passive <- siteSummary_passive %>%
  group_by(site) %>%
  summarize(hits= as.numeric(any(EAR > 0.1)),
            nChem = length(unique(chnm[EAR > 0.1])),
            nEndPoints = length(unique(endPoint[EAR > 0.1])),
            maxEAR = max(EAR))%>%
  arrange(desc(maxEAR))


```


```{r, eval=TRUE, echo=FALSE}
AC50gain_bm <- select(pCodeInfo, srsname, casrn, AqT_EPA_acute, 
                   AqT_EPA_chronic, AqT_other_acute, AqT_other_chronic)

AC50_bm <- left_join(AC50gain_bm, pCodeInfo[pCodeInfo$parameter_cd %in% waterSamplePCodes,c("casrn", "parameter_units", "mlWt")],
                   by= c("casrn"="casrn")) %>%
  filter(!is.na(parameter_units)) %>%
  rename(desiredUnits = parameter_units) %>%
  mutate(conversion = 1) %>%
  select(casrn, srsname, desiredUnits, mlWt, conversion)

AC50Converted_bm <- left_join(AC50_bm, AC50gain_bm, by = c("casrn", "srsname")) %>%
  rename(casn=casrn, chnm=srsname)

infoColumns <- c("casn", "chnm", "desiredUnits","mlWt", "conversion")

endPointData_bm <- AC50Converted_bm[,!(names(AC50Converted_bm) %in% infoColumns)]
endPointData_bm <- endPointData_bm * AC50Converted_bm$conversion
AC50_bm <- rename(AC50_bm, casn=casrn, chnm=srsname)
endPoint_bm <- cbind(AC50_bm, data.frame(endPointData_bm))
endPoint_bm <- rename(endPoint_bm, Units=desiredUnits)

chemicalSummary_BM <- wData %>%
  gather(pCode,measuredValue,-ActivityStartDateGiven,-site) %>%
  filter(!is.na(measuredValue)) %>%
  rename(date=ActivityStartDateGiven) %>%
  separate(pCode,c("colHeader","pCode"),"_") %>%
  left_join(pCodeInfo[c("parameter_cd","casrn","class")], by=c("pCode"="parameter_cd")) %>%
  right_join(endPoint_bm, by=c("casrn"="casn")) %>%
  select(-mlWt, -conversion, -casrn,  -Units, -colHeader, -pCode)%>%
  gather(endPoint, endPointValue, -class, -site, -measuredValue,-chnm,-date) %>%
  filter(!is.na(endPointValue)) %>%
  mutate(EAR=measuredValue/endPointValue) 

tempSamples_bm <- select(chemicalSummary_BM,date,site,chnm) %>%
    distinct()%>%
    group_by(chnm) %>%
    summarise(nSamples=n())

chemSum1_BM <- chemicalSummary_BM %>%
  mutate(hits= as.numeric(EAR > 0.1)) %>%
  group_by(chnm,  class, site) %>%
  summarize(hits=as.numeric(any(hits > 0))) %>%
  group_by(chnm, class) %>%
  summarize(freq=sum(hits)/n_distinct(site),
            nSites=sum(hits)) 

chemSum2_BM <- chemicalSummary_BM %>%
  group_by(chnm,  class) %>%  
  summarize(maxEAR=max(EAR), 
            nEndPoints=length(unique(endPoint[EAR > 0.1]))) %>%
  left_join(chemSum1_BM, by=c("chnm","class")) %>%
  left_join(tempSamples_bm, by="chnm") %>%
  data.frame %>%
  arrange(desc(freq)) %>%
  select(chnm, class, freq, maxEAR, nEndPoints, nSites, nSamples)

siteSummary_BM <- wData %>%
  gather(pCode,measuredValue,-ActivityStartDateGiven,-site) %>%
  filter(!is.na(measuredValue)) %>%
  rename(date=ActivityStartDateGiven) %>%
  separate(pCode, into=c("colHeader","pCode"),"_") %>%
  left_join(pCodeInfo[c("parameter_cd","casrn","class")], by=c("pCode"="parameter_cd")) %>%
  select(casrn, class, measuredValue, site, date) %>%
  right_join(endPoint_bm, by=c("casrn"="casn")) %>%
  select(-mlWt, -conversion, -casrn,  -Units) %>%
  gather(endPoint, endPointValue, -class, -site, -date, -measuredValue, -chnm) %>%
  filter(!is.na(endPointValue)) %>%
  mutate(EAR=measuredValue/endPointValue) %>%
  mutate(site=newSiteKey[site]) %>%
  select(site, chnm, EAR, endPoint, class, date) %>% 
  arrange(site, chnm, EAR)

summ1_BM <- siteSummary_BM %>%
  group_by(site, date) %>%
  summarize(hits= as.numeric(any(EAR > 0.1))) %>%
  group_by(site) %>%
  summarize(freq=sum(hits)/n_distinct(date),
            nSamples=n_distinct(date)) 

summ2_BM <-  siteSummary_BM %>%
  group_by(site) %>%
  summarize(nChem = length(unique(chnm[EAR > 0.1])),
            nEndPoints = length(unique(endPoint[EAR > 0.1])),
            maxEAR = max(EAR))


summary_BM <- left_join(summ1_BM, summ2_BM, by="site") %>%
  arrange(desc(maxEAR))

```

# Introduction {#intro}

## Screening Endpoints Used in Analysis

* ToxCast: (EPA NCCT)
    * "High throughput screening assays"
        * In-vitro Exposures to living cells or isolated proteins
        * Screens for potential adverse biological effects
        * Much is focused on gaining information on biological pathways
    * 1860 compounds
    * 821 endpoints
    * AC50 used for this analysis (concentration at which activity is 50% of its maximum)
    * Exposure:Activity Ratio (EAR) = concentration / AC50
* Established Water quality guidelines
    * Water sample analysis (not complete for passive samplers yet)
        * USEPA
        * Canadian Council of Ministers of the Environment
        * USGS
        * Literature

## Matches of Screening Endpoints
* Which chemicals are included in ToxCast and Water Quality Guideline assessments?
    + Water samples
        * `r length(unique(chemSum2$chnm))` compounds of `r length(waterSamplePCodes)` total 
        * `r paste(unique(chemSum2$class), collapse=", ")`
    + Passive samplers
        * `r length(unique(chemSum2_passive$chnm))`  compounds of `r length(unique(passiveData$Chemical))` total
        *  `r paste(unique(chemSum2_passive$class), collapse=", ")`
* Water Quality Guidelines
    + Water samples
        * `r length(unique(chemSum2_BM$chnm))` compounds of `r length(waterSamplePCodes)` total
        * `r paste(unique(chemSum2_BM$class), collapse=", ")`


# ToxCast, Water Sample Data {#toxWS}

Water samples were analyzed for the following classes of compounds with the number of individual compounds per class in parenthesis.

```{r echo=FALSE, eval=TRUE}
library(knitr)
library(pander)
ws <- c("PAH (6)", "Insecticides (6)", "Herbicides (7)", "Fire retardants (4)", "Pharmaceuticals (3)", "Plasticizers (5)", "Detergent metabolites (8)", "Antimicrobial disinfectants (3)", "Solvents (2)", "Fuels (4)", "Dye/pigments (1)", "Flavors &amp; fragrances (10)", "Sterols (4)", "Misc (3)")

ps <- c("PAH (33)", "Organic Waste Compounds (53)", "Organochlorine Pesticides (32)", "PBDEs (5)", "Pharmaceuticals (31)", "PCB (sum of total)",rep("", 8))

df <- data.frame(ws=ws,  stringsAsFactors=FALSE)

names(df) <- c("Water Samples: Organic Waste Compounds")

pander(df)

```


## ToxCast, Water Samples: Detection Levels

As an initial exploration of limitations of using ToxCast with the water sample data, ToxCast endpoints were compared with detection levels for each analyzed compound. The exposure:activity ratio (EAR) for a concentration at the detection level for the endpoint with the minimum AC50 for that chemical is presented in this table.  Only compounds with detection levels great than 10% of the lowest AC50 are included.

```{r warning=FALSE, echo=FALSE}
pCodeSummary <- select(pCodeInfo, srsname, casrn, parameter_units, mlWt) %>%
  filter(pCodeInfo$parameter_cd %in% waterSamplePCodes)

detectionLimits <- waterSamples[,grep("detectionLimit", names(waterSamples))]
detectionLimits <- na.omit(detectionLimits)

detLevels  <- data.frame(dl_pcode=names(detectionLimits),
                         minDetLevel=apply(detectionLimits, 2, min),
                         row.names=NULL, stringsAsFactors=FALSE) %>%
  mutate(pCode=sapply(strsplit(dl_pcode, "_"), function(x) x[2])) %>%
  left_join(pCodeInfo[c("parameter_cd","casrn","class")], 
            by=c("pCode"="parameter_cd")) %>%
  select(casrn, class, minDetLevel) %>%
  right_join(endPoint, by=c("casrn"="casn")) %>%
  select(-mlWt, -conversion, -casrn,  -Units) %>%
  gather(endPoint, endPointValue,-class, -minDetLevel,-chnm) %>% 
  filter(!is.na(endPointValue)) %>%
  mutate(EAR=minDetLevel/endPointValue) %>%
  filter(EAR >= 0.1) %>%
  select(Chemical=chnm, Class=class, EAR, endPoint, minDetLevel) %>%
  arrange(desc(EAR)) 


datatable(detLevels, rownames = FALSE,options = list(pageLength = 10))  %>% 
    formatRound(c("EAR","minDetLevel"), digits = 1)

```


## ToxCast, Water Samples: Chemical Summary Tables

This table focuses on the individual compounds and the prevalence of potential adverse biological effects (57 total sites). The table can be sorted by the fraction of sites with hits, maximum EAR, and number of endpoints with hits to evaluate results based on different priorities. "Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater.

```{r, echo=FALSE, results='asis'}

datatable(chemSum2[,-6], rownames = FALSE, 
            options = list(pageLength = 10), 
            colnames=c("Chemical","Class","Fraction of Sites with Hits","Maximum EAR","Number of End Points with Hits",  "Total Samples")) %>% 
    formatRound(c("maxEAR", "freq"), digits = 3)
```

### ToxCast, Water Samples: Individual EndPoints
This table focuses on the individual endpoint/compound combinations and the prevalence of potential adverse biological effects (57 total sites). The table can be sorted by the fraction of sites with hits, maximum EAR, endpoints with hits, and several variables that describe the ToxCast endpoints to evaluate results based on different priorities. "Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater.

```{r message=FALSE, results='asis', echo=FALSE}


chemSum3 <- chemicalSummary %>%
  mutate(hits= as.numeric(EAR > 0.1)) %>%
  group_by(chnm,  class, site, endPoint) %>%
  summarize(hits=as.numeric(any(hits > 0)),
            maxEAR=max(EAR)) %>%
  group_by(chnm, class, endPoint) %>%
  summarize(freq=sum(hits)/n_distinct(site),
            nSites=sum(hits),
            maxEAR=max(maxEAR)) %>%
  mutate(endPoint=as.character(endPoint))%>%
  left_join(endPointInfo, by=c("endPoint"="assay_component_endpoint_name")) %>% 
  select(chnm, maxEAR, freq, nSites, 
         endPoint, class, contains("intended_target_")) %>%
  rename(type=intended_target_type, type_sub=intended_target_type_sub,
         family=intended_target_family, family_sub=intended_target_family_sub) %>%
  select(-contains("intended_target_"))  %>%
  data.frame %>%
  arrange(desc(freq)) 

  datatable(distinct(chemSum3[,-4]), rownames = FALSE, 
            options = list(pageLength = 10), 
            colnames=c("Chemical","Maximum EAR","Fraction of Sites with Hits","Endpoint","Class","Type","Type_sub","Family","Family_sub")) %>% 
    formatRound(c("maxEAR", "freq"), digits = 2)
  
  
totalSamples_ep <- select(chemicalSummary,site,endPoint) %>%
  distinct()%>%
  group_by(endPoint) %>%
  summarise(totalSites=n())%>%
  mutate(endPoint=as.character(endPoint))
  
endpointSummary <- chemicalSummary %>%
  mutate(hits= as.numeric(EAR > 0.1)) %>%
  group_by(site, endPoint) %>%
  summarize(hits=as.numeric(any(hits > 0)),
            maxEAR=max(EAR)) %>%
  group_by(endPoint) %>%
  summarize(nSites=sum(hits),
            maxEAR=max(maxEAR))  %>%
  mutate(endPoint=as.character(endPoint))%>%
  left_join(endPointInfo, by=c("endPoint"="assay_component_endpoint_name")) %>% 
  left_join(totalSamples_ep, by=c("endPoint")) %>%
  mutate(freq=nSites/totalSites)%>%
  select(endPoint, maxEAR, freq, nSites, 
         endPoint, contains("intended_target_")) %>%
  rename(type=intended_target_type, type_sub=intended_target_type_sub,
         family=intended_target_family, family_sub=intended_target_family_sub) %>%
  select(-contains("intended_target_"))  %>%
  data.frame %>%
  arrange(desc(freq)) 

  datatable(distinct(endpointSummary), rownames = FALSE, 
            options = list(pageLength = 10), 
            colnames=c("End Point","Maximum EAR","Fraction of Sites with Hits","nSites","Type","Type_sub","Family","Family_sub")) %>% 
    formatRound(c("maxEAR", "freq"), digits = 2)


```

## ToxCast, Water Samples: Site Summaries

This table focuses on the individual sites and the prevalence of potential adverse biological effects (`r length(unique(chemSum2$chnm))` total chemicals included in ToxCast). The table can be sorted by the fraction of samples with hits, number of chemicals with hits, number of endpoints with hits, maximum EAR, and land cover attributes to evaluate results based on different priorities. "Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater.

```{r, echo=FALSE, results='asis'}
summary_display <- left_join(summary, stationINFO[,c("shortName","Ag.pct","Urban.pct")], by=c("site"="shortName")) 

datatable(summary_display, rownames = FALSE, 
          colnames=c("Station Name","Fraction of Samples with Hits", "Total Samples","Number of Chemicals with Hits", "Number of End Points with Hits", "Maximum EAR","Ag [%]","Urban [%]")) %>% 
  formatRound(c("freq","maxEAR","Ag.pct","Urban.pct"), digits = 2)
```

## ToxCast, Water Sample: Boxplots by Site
This figure displays ranges of EAR values for each site. Information on the number of endpoints with hits, number of chemicals with hits, and the total number of collected samples is included. "Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater. Only samples with hits are included.


```{r fig.width=7, fig.height=7, echo=FALSE,warning=FALSE, message=FALSE}
# summary_display1 <- transform(summary_display, 
#                              site = reorder(site, order(nChem,decreasing=TRUE)))

siteLimits <- filter(summary_display, freq>0) %>%
  arrange(desc(nChem), desc(nEndPoints)) %>%
  select(site,nEndPoints,nChem, nSamples)


summary_display2 <- siteSummary %>%
  filter(EAR>0.1)

sToxWS <- ggplot(summary_display2, aes(x=site, y=EAR)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.25), 
        legend.position = "none")+
  scale_x_discrete(limits=siteLimits$site) +
  scale_y_log10(limits=c(0.03,5000)) +
  labs(x = "Site") +
  geom_text(data=data.frame(), aes(x=siteLimits$site, y=0.07,
                                   label=siteLimits$nEndPoints),size=3) +
  geom_text(data=data.frame(), aes(x=siteLimits$site, y=0.045,
                                   label=siteLimits$nChem),size=3) +
  geom_text(data=data.frame(), aes(x=siteLimits$site, y=0.03,
                                   label=siteLimits$nSamples),size=3) +
  annotation_custom(grob=textGrob("EndPoints:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.9, xmax = -0.9, ymin = log10(0.07), ymax = log10(0.07)) +
  annotation_custom(grob=textGrob("Chemicals:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.9, xmax = -0.9, ymin = log10(0.045), ymax = log10(0.045)) +
  annotation_custom(grob=textGrob("Samples:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.9, xmax = -0.9, ymin = log10(0.03), ymax = log10(0.03))


g_sToxWS <- ggplotGrob(sToxWS)
g_sToxWS$layout$clip[g_sToxWS$layout$name=="panel"] <- "off"
grid.draw(g_sToxWS)

```

## ToxCast, Water Sample: Boxplots by Chemical

This figure displays ranges of EAR values for each chemical. Information on the number of endpoints with hits, and percentage of sites with hits is included. "Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater. Only samples with hits are included.

```{r fig.width=7, fig.height=7, echo=FALSE,warning=FALSE, message=FALSE}

chemLimits <- filter(chemSum2, freq>0) %>%
  arrange(desc(freq),desc(nEndPoints)) %>%
  select(chnm, nEndPoints, freq) %>%
  mutate(freq=sprintf("%.0f",100*freq))

chemicalSummary_display <- chemicalSummary %>%
  filter(EAR>=0.1) 

chemToxWS <- ggplot(chemicalSummary_display, aes(x=chnm, y=EAR)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.25), 
        legend.position = "none") +
  scale_x_discrete(limits=chemLimits$chnm) +
  scale_y_log10(limits=c(0.045,5000)) +
  labs(x = "Chemical Name")+
  geom_text(data=data.frame(), aes(x=chemLimits$chnm, y=0.07,
                                   label=chemLimits$nEndPoints),size=3) +
  geom_text(data=data.frame(), aes(x=chemLimits$chnm, y=0.045,
                                   label=chemLimits$freq),size=3) +  
  annotation_custom(grob=textGrob("EndPoints:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.8, xmax = -0.8, ymin = log10(0.07), ymax = log10(0.07)) +  
  annotation_custom(grob=textGrob("Site Hits [%]:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.8, xmax = -0.8, ymin = log10(0.045), ymax = log10(0.045))

g_chemToxWS <- ggplotGrob(chemToxWS)
g_chemToxWS$layout$clip[g_chemToxWS$layout$name=="panel"] <- "off"
grid.draw(g_chemToxWS)

```

# ToxCast, Passive Data {#toxPassive}

Passive samples were analyzed for the following classes of compounds with the number of individual compounds per class in parenthesis.

```{r echo=FALSE, eval=TRUE}
library(knitr)
library(pander)
# ws <- c("PAH (6)", "Insecticides (6)", "Herbicides (7)", "Fire retardants (4)", "Pharmaceuticals (3)", "Plasticizers (5)", "Detergent metabolites (8)", "Antimicrobial disinfectants (3)", "Solvents (2)", "Fuels (4)", "Dye/pigments (1)", "Flavors &amp; fragrances (10)", "Sterols (4)", "Misc (3)")

ps <- c("PAH (33)", "Organic Waste Compounds (53)", "Organochlorine Pesticides (32)", "PBDEs (5)", "Pharmaceuticals (31)", "PCB (sum of total)")

df <- data.frame(ps=ps,  stringsAsFactors=FALSE)

names(df) <- c("Passive Samples")

pander(df)

```


## ToxCast, Passive: Detection Levels

As an initial exploration of limitations of using ToxCast with the passive data, ToxCast endpoints were compared with detection levels (MQL) for each analyzed compound. The exposure:activity ratio (EAR) for a concentration at the detection level is presented in this table. Only compounds with detection levels great than 10% of the lowest AC50 are included.

```{r warning=FALSE, echo=FALSE}

detLevels_passive  <- select(passiveData, Chemical, MQL, CAS, class) %>%
  right_join(endPoint_passive, by=c("CAS"="casn")) %>%
  select(-mlWt, -conversion,   -Chemical, -CAS) %>%
  gather(endPoint,endPointValue,-MQL,-chnm, -Units,-class) %>% 
  filter(!is.na(endPointValue)) %>%
  mutate(EAR=MQL/endPointValue) %>%
  filter(EAR >= 0.1) %>%
  select(Chemical=chnm, Class=class, EAR, endPoint, minDetLevel=MQL) %>%
  arrange(desc(EAR)) 


datatable(detLevels_passive, rownames = FALSE,options = list(pageLength = 10))  %>% 
    formatRound(c("EAR","minDetLevel"), digits = 1)

```


## ToxCast, Passive: Chemical Summary Tables

This table focuses on the individual compounds, and the prevalence of potential adverse biological effects (57 total sites). The table can be sorted by the fraction of sites with hits, maximum exposure:activity ratio (EAR), and number of endpoints with hits to evaluate results based on different priorities. "Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater.

```{r, echo=FALSE, results='asis'}
chemSum2_passive_dt <- chemSum2_passive[,-6:-7] %>%
  filter(freq > 0)

datatable(chemSum2_passive_dt, rownames = FALSE, 
            options = list(pageLength = 10),
            colnames=c("Chemical","Class","Fraction of Sites with Hits","Maximum EAR","Number of End Points with Hits")) %>% 
    formatRound(c("maxEAR", "freq"), digits = 4)

```

### ToxCast, Passive: Individual EndPoints
This table focuses on the individual endpoint/compound combinations, and the prevalence of potential adverse biological effects (57 total sites). The table can be sorted by the fraction of sites with hits, maximum exposure:activity ratio (EAR), endpoints with hits, and several variables that describe the ToxCast endpoints to evaluate results based on different priorities. "Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater.

```{r message=FALSE, results='asis', echo=FALSE}


chemSum3_passive <- chemicalSummary_passive %>%
  group_by(chnm,  class, site, endPoint) %>%
  summarize(hits= as.numeric(any(EAR > 0.1))) %>% 
  group_by(chnm, class, endPoint) %>%
  summarize(freq=sum(hits)/n_distinct(site),
            nSites=sum(hits)) 

chemSum4_passive <- chemicalSummary_passive %>%
  group_by(chnm,  class, endPoint) %>%  
  summarize(maxEAR=max(EAR), 
            nSamples=1) %>%
  left_join(chemSum3_passive, by=c("chnm","class","endPoint")) %>%
  select(chnm, class, freq, maxEAR, nSamples, endPoint) %>%
  left_join(endPointInfo, by=c("endPoint"="assay_component_endpoint_name")) %>% 
  select(chnm, maxEAR, freq, endPoint, class, contains("intended_target_")) %>%
  rename(type=intended_target_type, 
         type_sub=intended_target_type_sub,
         family=intended_target_family, 
         family_sub=intended_target_family_sub) %>%
  select(-contains("intended_target_"))  %>%
  data.frame %>%
  arrange(desc(freq))  %>%
  filter(freq > 0)


  datatable(distinct(chemSum4_passive), rownames = FALSE, 
            options = list(pageLength = 10), 
            colnames=c("Chemical","Maximum EAR","Fraction of Sites with Hits","Endpoint","Class","Type","Type_sub","Family","Family_sub")) %>% 
    formatRound(c("maxEAR", "freq"), digits = 2)

```

## ToxCast, Passive: Site Summaries

This table focuses on the individual sites, and the prevalence of potential adverse biological effects (`r length(unique(chemSum2_passive$chnm))` total chemicals included in ToxCast). The table can be sorted by number of chemicals with hits, number of endpoints with hits, maximum exposure:activity ratio (EAR), and land cover attributes to evaluate results based on different priorities. "Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater.

```{r, echo=FALSE, results='asis'}
summary_display_passive <- left_join(summ1_passive, stationINFO[,c("shortName","Ag.pct","Urban.pct")], by=c("site"="shortName")) 
  
summary_display_passive <- summary_display_passive[,-2]
datatable(summary_display_passive, rownames = FALSE,
          colnames=c("Station Name", "Number of Chemicals with Hits", "Number of End Points with Hits", "Maximum EAR", "Ag [%]", "Urban [%]")) %>% 
#           options = list(pageLength = 50)) %>% 
  formatRound(c("maxEAR"), digits = 2)
```

## ToxCast, Passive: Boxplots by Sites

This figure displays ranges of exposure:activity ratio (EAR) values for each site. Information on the number of endpoints with hits and number of chemicals with hits is included."Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater. Only samples with hits are included.

```{r fig.width=7, fig.height=7, echo=FALSE,warning=FALSE, message=FALSE}

summary_display1_passive <- transform(summary_display_passive, 
                             site = reorder(site, order(nChem,decreasing=TRUE)))

siteLimits_passive <- filter(summary_display_passive, nChem>0) %>%
  arrange(desc(nChem)) %>%
  select(site,nEndPoints,nChem)


summary_display2_passive <- siteSummary_passive %>%
  filter(EAR>0.1)


sp <- ggplot(summary_display2_passive, aes(x=site, y=EAR)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.25), 
        legend.position = "none")+
  ylim(-1,10) + 
  scale_x_discrete(limits=siteLimits_passive$site)+
  labs(x = "Site") +
  geom_text(data=data.frame(), aes(x=siteLimits_passive$site,
                                   y=-0.5, label=siteLimits_passive$nEndPoints),size=3) +
  geom_text(data=data.frame(), aes(x=siteLimits_passive$site,
                                   y=-1, label=siteLimits_passive$nChem),size=3) +
  annotation_custom(grob=textGrob("EndPoints:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.7, xmax = -0.7, ymin = -0.5, ymax = -0.5) +
  annotation_custom(grob=textGrob("Chemicals:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.7, xmax = -0.7, ymin = -1, ymax = -1)

g_sp <- ggplotGrob(sp)
g_sp$layout$clip[g_sp$layout$name=="panel"] <- "off"
grid.draw(g_sp)


```


## ToxCast, Passive: Boxplots by Chemical

This figure displays ranges of EAR values for each chemical. Information on the number of endpoints with hits, and percentage of sites with hits is included."Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater. Only samples with hits are included.


```{r fig.width=7, fig.height=7, echo=FALSE,warning=FALSE, message=FALSE}

chemLimits_passive <- filter(chemSum2_passive, freq>0) %>%
  arrange(desc(freq)) %>%
  mutate(freq=sprintf("%.0f",100*freq)) %>%
  select(chnm, nEndPoints, nSites)

chemicalSummary_display_passive <- chemicalSummary_passive %>%
  filter(EAR>=0.1) 

cp <- ggplot(chemicalSummary_display_passive, aes(x=chnm, y=EAR)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.25), 
        legend.position = "none") +
  ylim(-1,10) + 
  scale_x_discrete(limits=chemLimits_passive$chnm) +
  labs(x = "Chemical Name") +
  geom_text(data=data.frame(), aes(x=chemLimits_passive$chnm, y=-0.5,
                                   label=chemLimits_passive$nEndPoints),size=3) +
  geom_text(data=data.frame(), aes(x=chemLimits_passive$chnm, y=-1,
                                   label=chemLimits_passive$nSites),size=3) +
  annotation_custom(grob=textGrob("EndPoints:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = 0.5, xmax = 0.5, ymin = -0.5, ymax = -0.5) +
  annotation_custom(grob=textGrob("Sites:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = 0.5, xmax = 0.5, ymin = -1, ymax = -1)


g_cp <- ggplotGrob(cp)
g_cp$layout$clip[g_cp$layout$name=="panel"] <- "off"
grid.draw(g_cp)

```


# Water Quality Guidelines, Water Samples {#WQGws}

## Water Quality Guidelines, Water Samples: Detection Levels

As an initial exploration of limitations of using water quality guidelines with the water sample data, water quality guidelines endpoints were compared with detection levels for each analyzed compound. The exposure:activity ratio (EAR) for a concentration at the detection level is presented in this table.  Only compounds with detection levels great than 10% of the lowest AC50 are included.

```{r warning=FALSE, echo=FALSE}

detLevels_BM  <- data.frame(dl_pcode=names(detectionLimits),
                         minDetLevel=apply(detectionLimits, 2, min),
                         row.names=NULL, stringsAsFactors=FALSE) %>%
  mutate(pCode=sapply(strsplit(dl_pcode, "_"), function(x) x[2])) %>%
  left_join(pCodeInfo[c("parameter_cd","casrn","class")], 
            by=c("pCode"="parameter_cd")) %>%
  select(casrn, class, minDetLevel) %>%
  right_join(endPoint_bm, by=c("casrn"="casn")) %>%
  select(-mlWt, -conversion, -casrn) %>%
  gather(endPoint,endPointValue,-class, -minDetLevel,-chnm,-Units) %>% 
  filter(!is.na(endPointValue)) %>%
  mutate(EAR=minDetLevel/endPointValue) %>%
  filter(EAR >= 0.1) %>%
  select(Chemical=chnm, Class=class, EAR, endPoint, minDetLevel) %>%
  arrange(desc(EAR)) 


datatable(detLevels_BM, rownames = FALSE,options = list(pageLength = 10))  %>% 
    formatRound(c("EAR","minDetLevel"), digits = 1)

```


## Water Quality Guidelines, Water Samples: Chemical Summary Tables

This table focuses on the individual compounds, and the prevalence of potential adverse biological effects (57 total sites). The table can be sorted by the fraction of sites with hits, maximum EAR, and number of endpoints with hits to evaluate results based on different priorities."Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater.


```{r, echo=FALSE, results='asis'}
  
datatable(chemSum2_BM[-6], rownames = FALSE, 
            options = list(pageLength = 10), 
            colnames=c("Chemical","Class","Fraction of Sites with Hits","Maximum EAR","Number of End Points with Hits", "Total Samples")) %>% 
    formatRound(c("maxEAR", "freq"), digits = 3)
```

## Water Quality Guidelines, Water Samples: Site Summaries

This table focuses on the individual endpoint/compound combinations, and the prevalence of potential adverse biological effects (57 total sites). The table can be sorted by the fraction of sites with hits, maximum EAR, endpoints with hits, and several variables that describe the water quality benchmark endpoints to evaluate results based on different priorities."Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater.


```{r, echo=FALSE, results='asis'}
summary_display_BM <- left_join(summary_BM, stationINFO[,c("shortName","Ag.pct","Urban.pct")], by=c("site"="shortName")) 

datatable(summary_display_BM, rownames = FALSE, 
          colnames=c("Station Name","Fraction Samples with Hits", "Total Samples","Number of Chemicals with Hits", "Number of End Points with Hits", "Maximum EAR","Ag [%]","Urban [%]")) %>% 
  formatRound(c("freq","maxEAR","Ag.pct","Urban.pct"), digits = 2)
```


## Water Quality Guidelines, Water Samples: Boxplots by Site

This figure displays ranges of EAR values for each site. Information on the number of endpoints with hits and number of chemicals with hits is included. "Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater. Only samples with hits are included.


```{r fig.width=7, fig.height=7, echo=FALSE,warning=FALSE, message=FALSE}

# summary_display1_BM <- transform(summary_display_BM, 
#                              site = reorder(site, order(nChem,decreasing=TRUE)))

siteLimits_BM <- filter(summary_display_BM, freq>0) %>%
  arrange(desc(nChem)) %>%
  select(site,nEndPoints,nChem,nSamples)


summary_display2_BM <- siteSummary_BM %>%
  filter(EAR>0.1)

sBenchWS <- ggplot(summary_display2_BM, aes(x=site, y=EAR)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.25), 
        legend.position = "none")+
  scale_x_discrete(limits=siteLimits_BM$site) +
  scale_y_log10(limits=c(0.03,250)) +
  labs(x = "Site") +
  geom_text(data=data.frame(), aes(x=siteLimits_BM$site, y=0.07,
                                   label=siteLimits_BM$nEndPoints),size=3) +
  geom_text(data=data.frame(), aes(x=siteLimits_BM$site, y=0.045,
                                   label=siteLimits_BM$nChem),size=3) +
  geom_text(data=data.frame(), aes(x=siteLimits_BM$site, y=0.03,
                                   label=siteLimits_BM$nSamples),size=3) +
  annotation_custom(grob=textGrob("EndPoints:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.9, xmax = -0.9, ymin = log10(0.07), ymax = log10(0.07)) +
  annotation_custom(grob=textGrob("Chemicals:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.9, xmax = -0.9, ymin = log10(0.045), ymax = log10(0.045)) +
    annotation_custom(grob=textGrob("Samples:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.9, xmax = -0.9, ymin = log10(0.03), ymax = log10(0.03))

g_sBenchWS <- ggplotGrob(sBenchWS)
g_sBenchWS$layout$clip[g_sBenchWS$layout$name=="panel"] <- "off"
grid.draw(g_sBenchWS)


```

## Water Quality Guidelines, Water Samples: Boxplots by Chemical

This figure displays ranges of EAR values for each chemical. Information on the number of endpoints with hits, and percentage of sites with hits is included. "Hits" are defined as EAR > 0.1, indicating that the measured concentration is 10% of the AC50 or greater. Only samples with hits are included.

```{r fig.width=7, fig.height=7, echo=FALSE,warning=FALSE, message=FALSE}

chemLimits_BM <- filter(chemSum2_BM, freq>0) %>%
  arrange(desc(freq)) %>%
  mutate(freq = sprintf("%.0f",100*freq)) %>%
  select(chnm, nEndPoints, freq)

chemicalSummary_display_BM <- chemicalSummary_BM %>%
  filter(EAR>=0.1) 

cBenchWS <- ggplot(chemicalSummary_display_BM, aes(x=chnm, y=EAR)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=0.25), 
        legend.position = "none") +
  scale_x_discrete(limits=chemLimits_BM$chnm) +
  scale_y_log10(limits=c(0.045,250)) +
  labs(x = "Chemical Name") +
  geom_text(data=data.frame(), aes(x=chemLimits_BM$chnm, y=0.07,
                                   label=chemLimits_BM$nEndPoints),size=3) +
  geom_text(data=data.frame(), aes(x=chemLimits_BM$chnm, y=0.045,
                                   label=chemLimits_BM$freq),size=3) +  
  annotation_custom(grob=textGrob("EndPoints:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.2, xmax = -0.2, ymin = log10(0.07), ymax = log10(0.07)) +  
  annotation_custom(grob=textGrob("Site Hits [%]:", gp = gpar(fontface = "italic", fontsize = 8)),xmin = -0.2, xmax = -0.2, ymin = log10(0.045), ymax = log10(0.045))

g_cBenchWS <- ggplotGrob(cBenchWS)
g_cBenchWS$layout$clip[g_cBenchWS$layout$name=="panel"] <- "off"
grid.draw(g_cBenchWS)
```


# Comparisons

This table is a comparison of the three different bio-effect evaluations (ToxCast with water samples, ToxCast with passive samples, water quality guidelines with water samples). The three classes that most commonly have potential adverse effects are highlighted (PAHs, pharmaceuticals, and pesticides).

```{r echo=FALSE}
# ToxCast Water Samples:
toxWS <- chemSum2 %>%
  filter(freq>0)%>%
  arrange(desc(freq)) %>%
  select(chnm,class,freq) %>%
  rename(Chemical=chnm, Class=class)

toxPassive <- chemSum2_passive %>%
  filter(freq>0)%>%
  arrange(desc(freq)) %>%
  select(chnm, class, freq) %>%
  rename(Chemical=chnm, Class=class)
  
toxPassive$Class[toxPassive$Class == "PAHs"] <- "PAH"

tradWS <- chemSum2_BM %>%
  filter(freq>0)%>%
  arrange(desc(freq)) %>%
  select(chnm, class, freq) %>%
  rename(Chemical=chnm, Class=class)

tradWS <- tradWS[1:20,1:2]
toxPassive <- toxPassive[1:20,1:2]
toxWS <- toxWS[1:20,1:2]

combo <- cbind(toxWS, toxPassive, tradWS)
names(combo) <- c("ToxCast-Water Samples: Chemical", "ToxCast-Water Samples: Class","ToxCast-Passive: Chemical", "ToxCast-Passive: Class","WQG-Water Samples: Chemical", "WQG-Water Samples: Class")
# emphasize.strong.cells(which(combo == "PAH", arr.ind = TRUE))
# pander(combo,row.names = FALSE, style = 'simple', split.table = Inf)


```


```{r, echo=FALSE, results='asis'}
formattable(combo, list(
  'ToxCast-Water Samples: Class' = formatter("span",
    style = x ~ ifelse(x == "PAH", 
                       style(color = "green", font.weight = "bold"), 
                   ifelse( x == "Pharmaceuticals", 
                               style(color = "red", font.weight = "bold"), 
                     ifelse(x == "Herbicide" | x == "Insecticide",
                               style(color = "blue", font.weight = "bold"),NA)))),
  'ToxCast-Passive: Class' = formatter("span",
    style = x ~ ifelse(x == "PAH", 
                       style(color = "green", font.weight = "bold"), 
                   ifelse( x == "Pharmaceuticals", 
                               style(color = "red", font.weight = "bold"), 
                     ifelse(x == "Herbicide" | x == "Insecticide",
                               style(color = "blue", font.weight = "bold"),NA)))),
   'WQG-Water Samples: Class' = formatter("span",
    style = x ~ ifelse(x == "PAH", 
                       style(color = "green", font.weight = "bold"), 
                   ifelse( x == "Pharmaceuticals", 
                               style(color = "red", font.weight = "bold"), 
                     ifelse(x == "Herbicide" | x == "Insecticide",
                               style(color = "blue", font.weight = "bold"),NA))))
))

# emphasize.strong.cells(which(combo == "Herbicide" | combo == "Insecticide", arr.ind = TRUE))
# pander(combo,row.names = FALSE,  split.table = Inf)
```


# Maps {#maps}

## ToxCast, Water Samples: Map
This map summarizes the water sample ToxCast results by showing maximum exposure:activity ratio (EAR) for each site as the color scale, and number of chemicals with hits as the symbol size. Additional information is available by clicking on the points.

<b>Color:</b> Maximum EAR<br/>
<b>Size:</b> Number of chemicals with hits (0-19)

```{r, echo=FALSE, results='asis', echo=FALSE, fig.width=7, fig.height=5}
stationINFO <- stationINFO[!is.na(stationINFO$dec.lat.va),]

mapData <- left_join(stationINFO, summary, by=c("shortName"="site"))
mapData <- mapData[!is.na(mapData$dec.lat.va),]
mapData <- mapData[!is.na(mapData$nChem),]


col_types <- c("darkblue","dodgerblue","green","yellow","orange","red")
leg_vals <- c(0,1,5,10,100,1000,2500)#seq(0,2500, 500) # This is maxEAR 

cols <- colorNumeric(col_types, domain = leg_vals)
rad <- seq(5000,15000, 500)
mapData$sizes <- rad[as.numeric(cut(mapData$nChem, c(-1:19)))]

pal = colorBin(col_types, mapData$maxEAR, bins = leg_vals)

m = leaflet(mapData) %>%
  addProviderTiles("Esri.WorldPhysical") %>%
  setView(lng = -83.5, lat = 44.5, zoom=6)%>%
  addCircles(lat=~dec.lat.va, lng=~dec.long.va, 
             popup=
    paste0('<b>',mapData$Station.Name,"</b><br/><table>",
   "<tr><td>Frequency</td><td>",sprintf("%1.1f",mapData$freq),'</td></tr>',
   "<tr><td>nSample</td><td>",mapData$nSamples,'</td></tr>',
   "<tr><td>maxEAR</td><td>",sprintf("%1.1f",mapData$maxEAR),'</td></tr>',
   "<tr><td>nChem</td><td>",mapData$nChem,'</td></tr>',
   "<tr><td>nEndPoints</td><td>",mapData$nEndPoints,'</td></tr></table>')
   ,
              fillColor = ~pal(maxEAR), 
             weight = 1,
             color = "black",
             fillOpacity = 0.8, radius = ~sizes, opacity = 0.8) %>%
    addLegend(
      position = 'bottomleft',
      pal=pal,
      values=~maxEAR,
      opacity = 0.8,
      title = 'Maximum EAR') 

m

```

## ToxCast, Passive: Map 
This map summarizes the passive ToxCast results by showing maximum exposure:activity ratio (EAR) for each site as the color scale, and number of chemicals with hits as the symbol size. Additional information is available by clicking on the points.

<b>Color:</b> Maximum EAR<br/>
<b>Size:</b> Number of chemicals with hits (0-3)

```{r, echo=FALSE, results='asis', echo=FALSE, fig.width=7, fig.height=5}

stationINFO <- stationINFO[!is.na(stationINFO$dec.lat.va),]

mapDataPassive <- left_join(stationINFO, summ1_passive, by=c("shortName"="site"))
mapDataPassive <- mapDataPassive[!is.na(mapDataPassive$dec.lat.va),]
mapDataPassive <- mapDataPassive[!is.na(mapDataPassive$maxEAR),]

col_types <- c("darkblue","dodgerblue","green","yellow","orange","red")
leg_vals <- c(0,1,2,3,5,7,9)#seq(0,2500, 500) # This is maxEAR scale

cols <- colorNumeric(col_types, domain = leg_vals)
rad <- seq(2500,15000, 2500)
mapDataPassive$sizes <- rad[as.numeric(cut(mapDataPassive$nChem, c(-1,0,1,2,3)))]
mapDataPassive$sizes[is.na(mapDataPassive$sizes)] <- 1000

pal = colorBin(col_types, mapDataPassive$maxEAR, bins = leg_vals)


map2 = leaflet(mapDataPassive) %>%
#   addProviderTiles("Hydda.Full") %>% # There are more maybe worth looking at
  addProviderTiles("Esri.WorldPhysical") %>%
  setView(lng = -83.5, lat = 44.5, zoom=6)%>%
  addCircles(lat=~dec.lat.va, lng=~dec.long.va, 
             popup=
               paste0("<b>",mapDataPassive$Station.Name,"</b><br/><table>",
    "<tr><td>maxEAR</td><td>",sprintf("%1.1f",mapDataPassive$maxEAR),'</td></tr>',
    "<tr><td>nChem</td><td>",mapDataPassive$nChem,'</td></tr>',
    "<tr><td>nEndPoints</td><td>",mapDataPassive$nEndPoints,'</td></tr></table>'),
             fillColor = ~pal(maxEAR), 
             weight = 1,
             color = "blue",
             fillOpacity = 0.8, radius = ~sizes, opacity = 0.8) %>%
    addLegend(
      position = 'bottomleft',
      pal=pal,
      values=~maxEAR,
#       colors = cols(leg_vals),
      opacity = 0.8,
#       labels = paste0(leg_vals,'-'),
      title = 'Maximum EAR')
map2

```


## Water Quality Guidelines, Water Samples: Map
This map summarizes the passive water quality guideline results by showing maximum exposure:activity ratio (EAR) for each site as the color scale, and number of chemicals with hits as the symbol size. Additional information is available by clicking on the points.

<b>Color:</b> Maximum EAR<br/>
<b>Size:</b> Number of chemicals with hits (0-10)

```{r echo=FALSE, results='asis', fig.width=7, fig.height=5}
mapDataWQ <- left_join(stationINFO, summary_BM, by=c("shortName"="site"))
mapDataWQ <- mapDataWQ[!is.na(mapDataWQ$dec.lat.va),]
mapDataWQ <- mapDataWQ[!is.na(mapDataWQ$maxEAR),]

col_types <- c("darkblue","dodgerblue","green","yellow","orange","red")
leg_vals_BM <- c(0,1,25,50,75,100,125)#seq(0,2500, 500) # This is maxEAR scale

colsWQ <- colorNumeric(col_types, domain = leg_vals_BM)
radWQ <- seq(2500,15000, 2500)
mapDataWQ$sizes <- rad[as.numeric(cut(mapDataWQ$nChem, c(-1,0,1,5,10)))]
mapDataWQ$sizes[is.na(mapDataWQ$sizes)] <- 1000

palWQ = colorBin(col_types, mapDataWQ$maxEAR, bins = leg_vals_BM)


map4 = leaflet(mapDataWQ) %>%
  addProviderTiles("Esri.WorldPhysical") %>%
  setView(lng = -83.5, lat = 44.5, zoom=6)%>%
  addCircles(lat=~dec.lat.va, lng=~dec.long.va, 
             popup=paste0("<b>",mapDataWQ$Station.Name,"</b><br/><table>",
  "<tr><td>maxEAR</td><td>",sprintf("%1.1f", mapDataWQ$maxEAR),'</td></tr>',
  "<tr><td>nChem</td><td>",mapDataWQ$nChem,'</td></tr>',
  "<tr><td>nEndPoints</td><td>", mapDataWQ$nEndPoints,'</td></tr></table>'),
             fillColor = ~palWQ(maxEAR), 
             weight = 1,
             color = "blue",
             fillOpacity = 0.8, radius = ~sizes, opacity = 0.8) %>%
    addLegend(
      position = 'bottomleft',
      pal=pal,
      values=~maxEAR,
#       colors = cols(leg_vals),
      opacity = 0.8,
#       labels = paste0(leg_vals,'-'),
      title = 'Maximum EAR') 
map4  

```





