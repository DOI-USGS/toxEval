---
title: "Shiny App"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
    number_sections: false
    fig_height: 10
    fig_width: 7
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Shiny App}
  \usepackage[utf8]{inputenc}
---


```{r setup, include=FALSE}
library(knitr)
library(rmarkdown)
options(continue=" ")
options(width=60)
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```


# Using the Shiny Application

All of the output on the Shiny app can be created directly in R as well. Using the app is a quick and convenient way to explore your data. For more customization, the R-code to produce each graph and table is displayed in the app. That is a good starting-point for a custom analysis. See the help file for any functions on details and example workflows.

To run the app, load the `toxEval` package, and run the `explore_endpoints` function:

```{r runApp, eval=FALSE}
library(toxEval)
explore_endpoints()
```

Your default browser will open up and display the following page:

![Main Layout of Shiny App](main.png)

Generally the app can be divided into 3 main sections:

The left sidebar (with the black background) will be used to load the data and set up the conditions for analysis. The options here will be described in the next section.

The top main section includes a variety of tabs to choose from to explore the data in different ways. Each section will be described in the section "Main Output".

The bottom section "R Code:" shows the exact code you could use to run directly in R to reproduce the analysis. The code can be copied and pasted directly into the R console, or (preferred for reproducible!) saved in an R script. One important note is that the local path to the file is not recorded, so if your data file is not located in your current working directory, you'll need to add the path to your file name.

## Sidebar options

<img style="float: right;" src="sidebar.png">

The sidebar offers a host of options for customizing the analysis. This document will attempt to describe the logistics of options. This document will NOT go into the scientific details of what options to choose. That will need to be up to the user. 


### A. Load Excel File 

Once the Shiny App has been started, the first step is to load the data. The data should be prepared as described in the ["Prepare Data" vignette](PrepareData.html). Click on the "Browse" button and navigate to the properly prepared Excel file. Once a file is picked, the data will be loaded into the application. There is a progress bar while the data loads, but sometimes it may take a little more time to view the data as each individual graph/map/table also takes some time to compute.

### B. 'Group By' option

The "Group By" radio buttons affect all output in the application. For each function, we will be summarizing the data by summing individual EARs. How we group those summations depends on this choice. 

The "Group" choice will group all of the endPoints that have similar groupings based on the options as determined by the designated "Annotation". The default annotation is "intended_target_family". With that choice, the "Group" radio button groups all EARs by the unique categories in the "intended_target_family" category.

The "Chemical" choice will group all of the endPoints in a single chemical (as defined by unique CAS).

The "Class" choice will group all of the endpoints in all of the chemicals as defined in the "Chemical" tab in the Excel file.

### C. Mean and Max: Summarize by site

The options are "MeanEAR" and "MaxEAR", and they dictate how to summarize the EARs per site. Each site may have different numbers of collected samples, and depending on the scope of your study, it may be more important to analyze the mean of the site, or look at the maximum at each site.

### D. Download benchmarks

Clicking on this button will download the a comma delimited (csv) file that could be used in the "Benchmark" tab (as described in the "Prepare Data" vignette). The provided columns are "CAS", "Chemical" (name), "flags", "endPoint", "ACC", "MlWt", "Value", "groupCol", and "assaysFull".

The "ACC" column is in log(μM), and the "Value" column is the conversion from that log(μM) to μg/L.
 
### E. Assay

<img style="float: right;" src="assays.png">

The assays dropdown menu offers the option to remove certain assays from the analysis. By default, the "BioSeek" assay is not included. Clicking on any of the options will not have an immediate affect until the "Switch Assays" button is clicked.

### F. Annotations

The "Annotations" dropdown offers the choice of which ToxCast grouping to analyze. By default, the "intended_target_family" is picked, but there may be other more appropriate options based on the scope of the analysis. Choosing a new annotation will not have an immediate affect until the "Switch Annotation" button is clicked.

### G. Group

The options in the "Group" dropdown change depending on the choice in Annotations. For "intended_target_family" for example, there would be the choices such as "Nuclear Receptors", "Cell Cycle", "DNA Binding", etc. You can ignore certain groups ("Background Measurement" for instance) by leaving the options unchecked. Clicking on and off the checkboxes will not have an immediate affect until the "Switch Groups" button is clicked.

### H. Flags

<img style="float: right;" src="flags.png">

The choices in the "Flags" dropdown are which flags to include in your analysis. By default, endPoints flagged with "Noisy Data", "Only one conc above baseline, active", and "Hit-call potentially confounded by overfitting" are included in the analysis. The scope of the analysis may cause you to want to include more or less flagged endPoints. Clicking on the flag checkboxes will not have an immediate affect until the "Switch Flags" button is clicked.

### I. Sites

By default, the analysis is done on all the sites. However, you can dig down to an individual sites using this dropdown menu. Each graph and table may show the individual site data a bit different than the full data set analysis, and that is described in the "Basic Workflow" vignette

### J. Hit Threshold

There are a few outputs (from the tabs: Hit Count, Site Hits, and Endpoint Hits) that will calculate the number of "Hits"...which is simply the number of times the EAR is above a designated threshold. That threshold value is defined here. Changing the threshold will not have an immedate affect until the "Change Hit Threshold" button is clicked.

## Main Output

Each plot and table offered in the app is described in the ["Basic Workflow" vignette](basicWorkflow.html). Please refer there for more information.

For each plot, there is an option to download the plot or data that is in the plot. The R-code to generate the output is also provided under each output. This would be the ideal way to customize any additional output.

The following table shows the main function that each tab in the app uses:

| Tab   |  Function |
|----------|------:|
| Map | [`make_tox_map`](basicWorkFlow.html#make_tox_map) |
| Box Plots | [`plot_tox_boxplots`](basicWorkFlow.html#plot_tox_boxplots) |
| Bar Charts | [`plot_tox_stacks`](basicWorkFlow.html#plot_tox_stacks)|
| Max EAR and Frequency | [`rank_sites_DT`](basicWorkFlow.html#rank_sites_DT)|
| Hit Counts | [`hits_summary_DT`](basicWorkFlow.html#hits_summary_DT)|
| Site Hits | [`table_tox_endpoint`](basicWorkFlow.html#table_tox_endpoint)|
| Endpoint Hits | [`table_endpoint_hits`](basicWorkFlow.html#table_endpoint_hits)|
| Endpoint | [`plot_tox_endpoints`](basicWorkFlow.html#plot_tox_endpoints)|
| Heat Map | [`plot_tox_heatmap`](basicWorkFlow.html#plot_tox_heatmap)|




# Logistics

## Reporting bugs

Please consider reporting bugs and asking questions on the Issues page:
[https://github.com/USGS-R/toxEval/issues](https://github.com/USGS-R/toxEval/issues)

## Citing toxEval

This package has not been reviewed and approved as a USGS-product. The implication is that `toxEval` cannot be cited in a publication. Once the software has been reviewed and approved, basic citation information will be available using the function:

```{r, eval=FALSE}
citation(package = "toxEval")
```


# Disclaimer

This software is in the public domain because it contains materials that originally came from the U.S. Geological Survey  (USGS), an agency of the United States Department of Interior. For more information, see the official USGS copyright policy at [https://www.usgs.gov/visual-id/credit_usgs.html#copyright](https://www.usgs.gov/visual-id/credit_usgs.html#copyright)

Although this software program has been used by the USGS, no warranty, expressed or implied, is made by the USGS or the U.S. Government as to the accuracy and functioning of the program and related program material nor shall the fact of distribution constitute any such warranty, and no responsibility is assumed by the USGS in connection therewith.

This software is provided "AS IS."

Any use of trade, firm, or product names is for descriptive purposes only and does not imply endorsement by the U.S. Government.

 [
   ![CC0](http://i.creativecommons.org/p/zero/1.0/88x31.png)
 ](http://creativecommons.org/publicdomain/zero/1.0/)


