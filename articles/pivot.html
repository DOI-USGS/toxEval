<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using R to prepare your Excel file • toxEval</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using R to prepare your Excel file">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53797708-7"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53797708-7');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">toxEval</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/Introduction.html">Background</a>
</li>
<li>
  <a href="../articles/basicWorkflow.html">Basic Workflow</a>
</li>
<li>
  <a href="../reference/index.html">Function Help</a>
</li>
<li>
  <a href="../articles/PrepareData.html">Data Preparation</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/shinyApp.html">Shiny App</a>
    </li>
    <li>
      <a href="../articles/benchmarks.html">Exploring Benchmarks</a>
    </li>
    <li>
      <a href="../articles/pivot.html">Prepare Data in R</a>
    </li>
    <li>
      <a href="../articles/does_curves.html">Dose Response Curves</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/bibliography.html">Bibliograpy</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/USGS-R/toxEval">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Using R to prepare your Excel file</h1>
            
            <h4 class="date">19 November, 2019</h4>
      
      
      <div class="hidden name"><code>pivot.Rmd</code></div>

    </div>

    
    
<p>This article will walk through prepping your data and exporting it to a Microsoft ™ Excel file using R. This article will focus on using functions and techniques from the “tidyverse” (<code>dplyr</code> + <code>tidyr</code> + many others…).</p>
<div id="pivot-from-wide-to-long" class="section level2">
<h2 class="hasAnchor">
<a href="#pivot-from-wide-to-long" class="anchor"></a>Pivot from wide to long</h2>
<p>It is very common for data to come back from the laboratory in a “wide” format. Also common for water quality data is to have the data values be interspaced with data remarks. The remark column could indicate censored data (ie “below detection limit”) or some information about the sampling conditions. We can use the <code>tidyr</code> package to “pivot” this data to the required long format used in <code>toxEval</code>.</p>
<p>Let’s make a small data set with 3 chemicals and 2 sampling sites. Each chemical has a value and remark.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">data_example &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="dt">site =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"A"</span>,<span class="st">"A"</span>,<span class="st">"B"</span>,<span class="st">"B"</span>),</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()<span class="op">:</span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()<span class="op">-</span><span class="dv">3</span>), </a>
<a class="sourceLine" id="cb1-4" data-line-number="4">                 <span class="dt">origin =</span> <span class="st">"1970-01-01"</span>),</a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="dt">a_value =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>),</a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  <span class="dt">a_rmk =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"&lt;"</span>,<span class="st">""</span>,<span class="st">""</span>,<span class="st">""</span>),</a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  <span class="dt">b_value =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">4</span><span class="op">:</span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  <span class="dt">b_rmk =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">""</span>,<span class="st">""</span>,<span class="st">""</span>,<span class="st">"&lt;"</span>),</a>
<a class="sourceLine" id="cb1-9" data-line-number="9">  <span class="dt">c_value =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span><span class="op">:</span><span class="dv">6</span>),</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  <span class="dt">c_rmk =</span> <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">""</span>,<span class="dv">4</span>),</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">  </a>
<a class="sourceLine" id="cb1-13" data-line-number="13">)</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">data_example</a></code></pre></div>
<pre><code>##   site       date a_value a_rmk b_value b_rmk c_value c_rmk
## 1    A 2019-11-19       1     &lt;       4             3      
## 2    A 2019-11-18       2             3             4      
## 3    B 2019-11-17       3             2             5      
## 4    B 2019-11-16       4             1     &lt;       6</code></pre>
<p>We will now use the “pivot_longer” function to make this wide data frame into a long data frame with the columns site, date, chemical, remark. The “names_to” can only be a vector if we can use the “names_pattern” to logically separate the column names.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyr)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">data_wide &lt;-<span class="st"> </span>data_example <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span>(<span class="dt">cols =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span>site, <span class="op">-</span>date), </a>
<a class="sourceLine" id="cb3-4" data-line-number="4">               <span class="dt">names_to =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Chemical"</span>, <span class="st">".value"</span>),</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">               <span class="dt">names_pattern =</span> <span class="st">"(.+)_(.+)"</span>)</a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(data_wide)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 5
##   site  date       Chemical value rmk  
##   &lt;chr&gt; &lt;date&gt;     &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;
## 1 A     2019-11-19 a            1 &lt;    
## 2 A     2019-11-19 b            4 ""   
## 3 A     2019-11-19 c            3 ""   
## 4 A     2019-11-18 a            2 ""   
## 5 A     2019-11-18 b            3 ""   
## 6 A     2019-11-18 c            4 ""</code></pre>
<p>What if the column names didn’t have the "_value" prepended? This is more common in our raw data:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">data_example2 &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  <span class="dt">site =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"A"</span>,<span class="st">"A"</span>,<span class="st">"B"</span>,<span class="st">"B"</span>),</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="dt">date =</span> <span class="kw"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()<span class="op">:</span>(<span class="kw"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.Date</a></span>()<span class="op">-</span><span class="dv">3</span>), </a>
<a class="sourceLine" id="cb5-4" data-line-number="4">                 <span class="dt">origin =</span> <span class="st">"1970-01-01"</span>),</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="dt">a =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>),</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="dt">a_rmk =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"&lt;"</span>,<span class="st">""</span>,<span class="st">""</span>,<span class="st">""</span>),</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">  <span class="dt">b =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">4</span><span class="op">:</span><span class="dv">1</span>),</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">  <span class="dt">b_rmk =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">""</span>,<span class="st">""</span>,<span class="st">""</span>,<span class="st">"&lt;"</span>),</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">  <span class="dt">c =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">3</span><span class="op">:</span><span class="dv">6</span>),</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">  <span class="dt">c_rmk =</span> <span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">""</span>,<span class="dv">4</span>),</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">)</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">data_example2</a></code></pre></div>
<pre><code>##   site       date a a_rmk b b_rmk c c_rmk
## 1    A 2019-11-19 1     &lt; 4       3      
## 2    A 2019-11-18 2       3       4      
## 3    B 2019-11-17 3       2       5      
## 4    B 2019-11-16 4       1     &lt; 6</code></pre>
<p>The easiest way to do that would be to add that "_value“. Keeping in the”tidyverse":</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb7-2" data-line-number="2"></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">data_wide2 &lt;-<span class="st"> </span>data_example2 <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select_all.html">rename_if</a></span>(<span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/grep.html">grepl</a></span>(<span class="st">"_rmk"</span>, <span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(.)) <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="st">              </span><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(.) <span class="op">!=</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"site"</span>,<span class="st">"date"</span>), </a>
<a class="sourceLine" id="cb7-6" data-line-number="6">            <span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/sprintf.html">sprintf</a></span>(<span class="st">'%s_value'</span>, .))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span>(<span class="dt">cols =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span>site, <span class="op">-</span>date), </a>
<a class="sourceLine" id="cb7-8" data-line-number="8">               <span class="dt">names_to =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Chemical"</span>, <span class="st">".value"</span>),</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">               <span class="dt">names_pattern =</span> <span class="st">"(.+)_(.+)"</span>)</a>
<a class="sourceLine" id="cb7-10" data-line-number="10"></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(data_wide2)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 5
##   site  date       Chemical value rmk  
##   &lt;chr&gt; &lt;date&gt;     &lt;chr&gt;    &lt;int&gt; &lt;chr&gt;
## 1 A     2019-11-19 a            1 &lt;    
## 2 A     2019-11-19 b            4 ""   
## 3 A     2019-11-19 c            3 ""   
## 4 A     2019-11-18 a            2 ""   
## 5 A     2019-11-18 b            3 ""   
## 6 A     2019-11-18 c            4 ""</code></pre>
</div>
<div id="opening-the-file" class="section level2">
<h2 class="hasAnchor">
<a href="#opening-the-file" class="anchor"></a>Opening the file</h2>
<p>To open an Excel file in R, use the <code>readxl</code> package. There are many…many</p>
<p>For example, let’s say the lab returned the data looking like this:</p>
<p><img src="messyData.png" width="414"></p>
<p>Let’s break down the issues:</p>
<ul>
<li>Top row contains the CAS</li>
<li>2nd row basically contains the useful column headers</li>
<li>Need to skip a random 3rd row</li>
<li>4th row has 2 column headers for the first 2 columns</li>
<li>The data starts in row 5, in a “wide” format</li>
<li>The date format is unusual</li>
</ul>
<p>In this example, we’ll work through these spacing and header issues to get us to a wide data frame that we can then pivot to a long data frame as described in the next section.</p>
<p>First, let’s just get the data with no column names:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(readxl)</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">data_no_header &lt;-<span class="st"> </span><span class="kw"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span>(here<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span>(<span class="st">"vignettes/Wide data example.xlsx"</span>),</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">                            <span class="dt">sheet =</span> <span class="st">"data_from_lab"</span>, </a>
<a class="sourceLine" id="cb9-4" data-line-number="4">                            <span class="dt">skip =</span> <span class="dv">4</span>, <span class="dt">col_names =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
<p><code>data_no_header</code> is now a data frame with accurate types (except for dates…we’ll get that later!), but no column names. We know the first 2 columns are site and date, so we can name those easily:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(data_no_header)[<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>] &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"SiteID"</span>, <span class="st">"Sample Date"</span>)</a></code></pre></div>
<p>Now we need to get the CAS values for the column names:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">headers &lt;-<span class="st"> </span><span class="kw"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_xlsx</a></span>(here<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/here/man/here.html">here</a></span>(<span class="st">"vignettes/Wide data example.xlsx"</span>),</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">                     <span class="dt">sheet =</span> <span class="st">"data_from_lab"</span>, </a>
<a class="sourceLine" id="cb11-3" data-line-number="3">                     <span class="dt">n_max =</span> <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="co"># Get rid or first 2 columns:</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">headers &lt;-<span class="st"> </span>headers[,<span class="op">-</span><span class="dv">1</span><span class="op">:-</span><span class="dv">2</span>]</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="co"># Let's look at the first 6 columns:</span></a>
<a class="sourceLine" id="cb11-7" data-line-number="7">headers[<span class="dv">1</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">6</span>]</a></code></pre></div>
<pre><code>## # A tibble: 1 x 6
##   ...3  `1912-24-9` ...5  `148-79-8`    ...7  `611-59-6`          
##   &lt;chr&gt; &lt;chr&gt;       &lt;chr&gt; &lt;chr&gt;         &lt;chr&gt; &lt;chr&gt;               
## 1 Code  Atrazine    Code  Thiabendazole Code  1,7-Dimethylxanthine</code></pre>
<p>It would be nice to use that first row as the column names in “data_no_header”, but then it would be very confusing what “Code” means (since it’s repeated). So, let’s remove the “Code”, and just repeat the chemical names:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">headers &lt;-<span class="st"> </span>headers[,<span class="kw"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(headers[<span class="dv">1</span>,]) <span class="op">!=</span><span class="st"> "Code"</span>)]</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"></a>
<a class="sourceLine" id="cb13-3" data-line-number="3">chem_names &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(headers[<span class="dv">1</span>,])</a>
<a class="sourceLine" id="cb13-4" data-line-number="4"></a>
<a class="sourceLine" id="cb13-5" data-line-number="5">column_names &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(chem_names, <span class="dt">each =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">column_names &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(column_names, <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"_code"</span>,<span class="st">"_Value"</span>))</a>
<a class="sourceLine" id="cb13-7" data-line-number="7"></a>
<a class="sourceLine" id="cb13-8" data-line-number="8"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(column_names)</a></code></pre></div>
<pre><code>## [1] "Atrazine_code"              "Atrazine_Value"            
## [3] "Thiabendazole_code"         "Thiabendazole_Value"       
## [5] "1,7-Dimethylxanthine_code"  "1,7-Dimethylxanthine_Value"</code></pre>
<p>Now, we can assign the “column_names” to the “data_no_header”:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(data_no_header)[<span class="op">-</span><span class="dv">1</span><span class="op">:-</span><span class="dv">2</span>] &lt;-<span class="st"> </span>column_names</a></code></pre></div>
<p>Before we pivot this data to the required long format (as described above), let’s get that “Sample Date” column in an R date time format:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">data_no_header<span class="op">$</span><span class="st">`</span><span class="dt">Sample Date</span><span class="st">`</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span>(data_no_header<span class="op">$</span><span class="st">`</span><span class="dt">Sample Date</span><span class="st">`</span>, </a>
<a class="sourceLine" id="cb16-2" data-line-number="2">                                <span class="dt">format =</span> <span class="st">"%Y%m%d%H%M"</span>)</a></code></pre></div>
<p>Now let’s pivot this to the long format:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">cleaned_long &lt;-<span class="st"> </span>data_no_header <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span>(<span class="dt">cols =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="op">-</span>SiteID, <span class="op">-</span><span class="st">`</span><span class="dt">Sample Date</span><span class="st">`</span>), </a>
<a class="sourceLine" id="cb17-3" data-line-number="3">               <span class="dt">names_to =</span> <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Chemical"</span>, <span class="st">".value"</span>),</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">               <span class="dt">names_pattern =</span> <span class="st">"(.+)_(.+)"</span>) </a></code></pre></div>
<p>But, since we’re doing a <code>toxEval</code> analysis, we need to get a “CAS” column. We can use that original “headers” data frame and do a <code>left_join</code> (from the “dplyr” package):</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">cas_df &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">Chemical =</span> <span class="kw"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>(headers[<span class="dv">1</span>,]),</a>
<a class="sourceLine" id="cb18-2" data-line-number="2">                     <span class="dt">CAS =</span> <span class="kw"><a href="https://rdrr.io/r/base/names.html">names</a></span>(headers), </a>
<a class="sourceLine" id="cb18-3" data-line-number="3">                     <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb18-4" data-line-number="4"></a>
<a class="sourceLine" id="cb18-5" data-line-number="5">cleaned_long &lt;-<span class="st"> </span>cleaned_long <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(cas_df, <span class="dt">by =</span> <span class="st">"Chemical"</span>)</a>
<a class="sourceLine" id="cb18-7" data-line-number="7"><span class="kw"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(cleaned_long)</a></code></pre></div>
<pre><code>## # A tibble: 6 x 6
##   SiteID   `Sample Date`       Chemical                 code     Value CAS      
##   &lt;chr&gt;    &lt;dttm&gt;              &lt;chr&gt;                    &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;    
## 1 Upstream 2016-08-01 10:00:00 Atrazine                 &lt;NA&gt;   0.0183  1912-24-9
## 2 Upstream 2016-08-01 10:00:00 Thiabendazole            &lt;      0.00410 148-79-8 
## 3 Upstream 2016-08-01 10:00:00 1,7-Dimethylxanthine     &lt;      0.0877  611-59-6 
## 4 Upstream 2016-08-01 10:00:00 10-Hydroxy-amitriptyline &lt;      0.0083  1159-82-6
## 5 Upstream 2016-08-01 10:00:00 11-Ketotestosterone      &lt;NA&gt;  NA       564-35-2 
## 6 Upstream 2016-08-01 10:00:00 17-alpha-Estradiol       &lt;NA&gt;  NA       57-91-0</code></pre>
<p>The “cleaned_long” data frame is ready to be used by <code>toxEval</code> in the “Data” tab. The “cas_df” is nearly ready for the “Chemical” tab. There is a mandatory “Class” column that needs to be added. Finally, we need to get the “Sites” tab needs be be created.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">chemical_tab &lt;-<span class="st"> </span>cas_df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">Class =</span> <span class="st">"to_add"</span>)</a>
<a class="sourceLine" id="cb20-3" data-line-number="3"></a>
<a class="sourceLine" id="cb20-4" data-line-number="4">sites_tab &lt;-<span class="st"> </span>cleaned_long <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(SiteID) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span>() <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="st">`</span><span class="dt">Short Name</span><span class="st">`</span> =<span class="st"> "to_add"</span>,</a>
<a class="sourceLine" id="cb20-8" data-line-number="8">         <span class="dt">dec_lat =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb20-9" data-line-number="9">         <span class="dt">dec_lon =</span> <span class="ot">NA</span>,</a>
<a class="sourceLine" id="cb20-10" data-line-number="10">         <span class="dt">site_grouping =</span> <span class="st">""</span>)</a></code></pre></div>
</div>
<div id="save-to-excel" class="section level2">
<h2 class="hasAnchor">
<a href="#save-to-excel" class="anchor"></a>Save to Excel</h2>
<p>The package <code>openxlsx</code> is nice for saving Excel files. Create a named list in R, and each of those parts of the list become a Worksheet in Excel:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">to_Excel &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">Data =</span> cleaned_long,</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">                 <span class="dt">Chemicals =</span> chemical_tab,</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">                 <span class="dt">Sites =</span> sites_tab)</a>
<a class="sourceLine" id="cb21-4" data-line-number="4"></a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(openxlsx)</a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="kw"><a href="https://rdrr.io/pkg/openxlsx/man/write.xlsx.html">write.xlsx</a></span>(to_Excel,</a>
<a class="sourceLine" id="cb21-7" data-line-number="7">           <span class="dt">file =</span> <span class="st">"toxEval_Input.xlsx"</span>)</a></code></pre></div>
</div>
<div id="disclaimer" class="section level1">
<h1 class="hasAnchor">
<a href="#disclaimer" class="anchor"></a>Disclaimer</h1>
<p>This information is preliminary or provisional and is subject to revision. It is being provided to meet the need for timely best science. The information has not received final approval by the U.S. Geological Survey (USGS) and is provided on the condition that neither the USGS nor the U.S. Government shall be held liable for any damages resulting from the authorized or unauthorized use of the information.</p>
<p>Any use of trade, firm, or product names is for descriptive purposes only and does not imply endorsement by the U.S. Government.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#pivot-from-wide-to-long">Pivot from wide to long</a></li>
      <li><a href="#opening-the-file">Opening the file</a></li>
      <li><a href="#save-to-excel">Save to Excel</a></li>
      <li><a href="#disclaimer">Disclaimer</a></li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Laura DeCicco, Steven Corsi, Daniel Villeneuve, Brett Blackwell, Gerald Ankley.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
